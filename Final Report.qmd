---
title: "VEREP Property Analysis Report"
author: "HDAdvisors"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    code-summary: "Show code"
    embed-resources: true
  pdf:
    toc: true
    toc-depth: 3
    geometry:
      - margin=1in
    mainfont: "Lato"
    sansfont: "Lato"
execute:
  warning: false
  message: false
---
```{css}
#| echo: false

@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Lato:wght@300;400;700&display=swap');

/* Apply HDA fonts */
body {
  font-family: 'Lato', sans-serif;
  color: #333333;
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Roboto Slab', serif;
  color: #445ca9;
}

/* Style callouts with HDA colors */
.callout-note {
  border-left-color: #445ca9 !important;
}

.callout-warning {
  border-left-color: #e76f52 !important;
}

.callout-tip {
  border-left-color: #8baeaa !important;
}

/* Style links */
a {
  color: #445ca9;
}

a:hover {
  color: #e9ab3f;
}
```

## Executive Summary

This analysis examines properties belonging to congregations with fewer than 30 Sunday attendees, focusing on development potential through five key metrics: land value, zoning/density, acreage, environmental limitations, and Qualified Census Tract (QCT) status.

## Setup
```{r setup}
#| label: setup
#| include: false

# Load packages quietly
library(tidyverse, quietly = TRUE, warn.conflicts = FALSE)
library(readr, quietly = TRUE)
library(scales, quietly = TRUE)
library(knitr, quietly = TRUE)
library(gt, quietly = TRUE)

# Knitr options to suppress warnings
options(
  knitr.kable.NA = '',
  dplyr.summarise.inform = FALSE,
  readr.show_col_types = FALSE,
  warn = -1
)

# HDA Color Palette
hda_colors <- c(
  blue = "#445ca9",
  green = "#8baeaa", 
  yellow = "#e9ab3f",
  coral = "#e76f52"
)

# Simplified theme without font dependencies
theme_hda <- function(base_size = 11) {
  theme_minimal(base_size = base_size) +
    theme(
      plot.title = element_text(
        face = "bold",
        color = hda_colors["blue"],
        size = rel(1.3)
      ),
      plot.subtitle = element_text(
        color = "#555555",
        size = rel(1)
      ),
      axis.title = element_text(color = "#555555"),
      axis.text = element_text(color = "#666666"),
      legend.title = element_text(color = hda_colors["blue"]),
      panel.grid.major = element_line(color = "#e0e0e0"),
      panel.grid.minor = element_blank()
    )
}

theme_set(theme_hda())
```

## Data Loading and Preparation
```{r load-data}
#| label: load-data

# Read the data
verep_data <- read_csv("data/verep040725.csv")
codebook <- read_csv("data/CGS_VEREP_AppendixD_Codebook.xlsx.csv")

# Read congregation attendance data
congregation_data <- read_csv("data/congregation.csv")
```

### Join Attendance Data
```{r join-data}
#| label: join-attendance

# Prepare attendance data with most recent year (2023) and average

attendance_data <- congregation_data |>
  select(
    quickref,
    congregation_name = name,
    short_name,
    attendance_2023 = f2023_sunday_attendance,
    attendance_avg,
    members_2023 = f2023_members_this_year,
    plate_pledge_2023 = f2023_plate_and_pledge,
    attendance_pctinc,
    dio_reg
  )

# Join property data with attendance data
verep_data <- verep_data |>
  left_join(
    attendance_data, 
    by = c("congr_name" = "quickref")
  )
```

::: {.callout-note}
## Join Results

- Total properties: `r nrow(verep_data)`
- Properties matched to congregation: `r sum(!is.na(verep_data$attendance_2023))`
- Properties with attendance data: `r sum(!is.na(verep_data$attendance_2023) & verep_data$attendance_2023 > 0)`

:::

## Filtering Criteria

We focus our analysis on properties with fewer than 30 Sunday attendees in 2023.
```{r filter-data}
#| label: filter-subset

analysis_subset <- verep_data |>
  filter(
    !is.na(attendance_2023) &
      attendance_2023 < 30
  )
```

**Properties included:** `r nrow(analysis_subset)` properties from `r n_distinct(analysis_subset$congr_name[!is.na(analysis_subset$congr_name)])` unique congregations.
```{r congregations-table}
#| label: tbl-congregations
#| tbl-cap: "Congregations with <30 Sunday Attendees"

congregations_under30 <- analysis_subset |>
  filter(!is.na(congr_name)) |>
  distinct(congr_name, attendance_2023, congregation_name) |>
  arrange(attendance_2023)

congregations_under30 |>
  gt() |>
  cols_label(
    congr_name = "Quick Reference",
    congregation_name = "Congregation Name",
    attendance_2023 = "2023 Attendance"
  ) |>
  tab_style(
    style = list(
      cell_fill(color = "#f8f9fa")
    ),
    locations = cells_body(rows = seq(2, nrow(congregations_under30), 2))
  ) |>
  tab_style(
    style = cell_text(
      weight = "bold",
      color = hda_colors["blue"]
    ),
    locations = cells_column_labels()
  ) |>
  tab_options(
    table.font.size = 11
  )
```
```

## Analysis Results

### Land Value Analysis {#sec-land-value}
```{r land-value}
#| label: land-value-summary

land_value_summary <- analysis_subset |>
  summarise(
    total_properties = n(),
    properties_with_value = sum(!is.na(lan_val)),
    mean_land_value = mean(lan_val, na.rm = TRUE),
    median_land_value = median(lan_val, na.rm = TRUE),
    min_land_value = min(lan_val, na.rm = TRUE),
    max_land_value = max(lan_val, na.rm = TRUE),
    total_land_value = sum(lan_val, na.rm = TRUE)
  )
```

The properties analyzed represent a total land value of **`r dollar(land_value_summary$total_land_value)`**, with a median value of **`r dollar(land_value_summary$median_land_value)`** per property.
```{r}
#| label: tbl-land-value
#| tbl-cap: "Land Value Summary Statistics"

land_value_summary |>
  select(-total_properties, -properties_with_value) |>
  pivot_longer(everything(), names_to = "Metric", values_to = "Value") |>
  mutate(
    Metric = str_replace_all(Metric, "_", " ") |> str_to_title(),
    Value = dollar(Value)
  ) |>
  gt() |>
  tab_style(
    style = cell_text(
      font = "Roboto Slab",
      weight = "bold",
      color = hda_colors["blue"]
    ),
    locations = cells_column_labels()
  ) |>
  tab_options(
    table.font.names = "Lato",
    table.font.size = 11
  )
```
```{r}
#| label: fig-land-value
#| fig-cap: "Distribution of Land Values"
#| fig-width: 8
#| fig-height: 5

analysis_subset |>
  filter(!is.na(lan_val)) |>
  ggplot(aes(x = lan_val)) +
  geom_histogram(bins = 30, fill = hda_colors["blue"], alpha = 0.8) +
  scale_x_continuous(labels = dollar_format()) +
  labs(
    title = "Distribution of Land Values",
    subtitle = "Church Properties with <30 Attendees",
    x = "Land Value",
    y = "Count"
  )
```

### Zoning & Density Analysis {#sec-zoning}
```{r zoning-analysis}
#| label: zoning-summary

zoning_summary <- analysis_subset |>
  filter(!is.na(zon)) |>
  count(zon, zon_desc, sort = TRUE) |>
  mutate(percentage = n / sum(n) * 100)

zoning_type_summary <- analysis_subset |>
  filter(!is.na(zon_type)) |>
  count(zon_type, sort = TRUE) |>
  mutate(percentage = n / sum(n) * 100)
```
```{r}
#| label: tbl-zoning
#| tbl-cap: "Top 10 Zoning Classifications"

head(zoning_summary, 10) |>
  gt() |>
  cols_label(
    zon = "Zone Code",
    zon_desc = "Description",
    n = "Count",
    percentage = "Percentage"
  ) |>
  fmt_number(columns = percentage, decimals = 1) |>
  cols_align(align = "left", columns = zon_desc) |>
  tab_style(
    style = cell_text(
      font = "Roboto Slab",
      weight = "bold",
      color = hda_colors["blue"]
    ),
    locations = cells_column_labels()
  ) |>
  tab_options(
    table.font.names = "Lato",
    table.font.size = 11
  )
```

### Acreage Analysis {#sec-acreage}
```{r acreage-analysis}
#| label: acreage-summary

acreage_summary <- analysis_subset |>
  summarise(
    properties_with_acreage = sum(!is.na(rgisacre)),
    mean_acres = mean(rgisacre, na.rm = TRUE),
    median_acres = median(rgisacre, na.rm = TRUE),
    total_acres = sum(rgisacre, na.rm = TRUE),
    min_acres = min(rgisacre, na.rm = TRUE),
    max_acres = max(rgisacre, na.rm = TRUE)
  )

acreage_categories <- analysis_subset |>
  filter(!is.na(rgisacre)) |>
  mutate(
    acreage_category = case_when(
      rgisacre < 0.5 ~ "< 0.5 acres",
      rgisacre < 1 ~ "0.5-1 acres",
      rgisacre < 2 ~ "1-2 acres",
      rgisacre < 5 ~ "2-5 acres",
      rgisacre < 10 ~ "5-10 acres",
      TRUE ~ "10+ acres"
    ),
    acreage_category = factor(acreage_category, levels = c(
      "< 0.5 acres", "0.5-1 acres", "1-2 acres", 
      "2-5 acres", "5-10 acres", "10+ acres"
    ))
  ) |>
  count(acreage_category, .drop = FALSE) |>
  mutate(percentage = n / sum(n) * 100)
```

The properties encompass a total of **`r round(acreage_summary$total_acres, 1)` acres**, with a median parcel size of **`r round(acreage_summary$median_acres, 2)` acres**.
```{r}
#| label: fig-acreage
#| fig-cap: "Acreage Distribution"
#| fig-width: 8
#| fig-height: 5

acreage_categories |>
  ggplot(aes(x = acreage_category, y = percentage)) +
  geom_col(fill = hda_colors["green"], alpha = 0.8) +
  geom_text(
    aes(label = sprintf("%.1f%%", percentage)), 
    vjust = -0.5, 
    size = 3.5,
    family = "Lato",
    color = "#555555"
  ) +
  labs(
    title = "Property Size Distribution",
    x = "Acreage Category",
    y = "Percentage of Properties"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Environmental Limitations {#sec-environmental}
```{r environmental-analysis}
#| label: environmental-summary

environmental_summary <- analysis_subset |>
  summarise(
    properties_with_wetlands = sum(wet_perc > 0, na.rm = TRUE),
    avg_wetland_coverage = mean(wet_perc, na.rm = TRUE),
    significant_wetlands = sum(wet_perc > 10, na.rm = TRUE),
    in_flood_zone = sum(!is.na(fema_fz) & fema_fz != "" & fema_fz != "X", na.rm = TRUE),
    in_high_risk_flood = sum(fema_fz %in% c("A", "AE", "AO", "AH", "V", "VE"), na.rm = TRUE),
    high_fema_risk = sum(fema_nri %in% c("Very High", "Relatively High"), na.rm = TRUE)
  )

flood_zone_summary <- analysis_subset |>
  filter(!is.na(fema_fz) & fema_fz != "") |>
  count(fema_fz, sort = TRUE) |>
  mutate(percentage = n / sum(n) * 100)
```

::: {.callout-warning}
## Environmental Constraints

- **`r environmental_summary$in_flood_zone`** properties located in flood zones
- **`r environmental_summary$significant_wetlands`** properties with >10% wetland coverage
- **`r environmental_summary$in_high_risk_flood`** properties in high-risk flood zones

:::

```{r}
#| label: fig-environmental
#| fig-cap: "Flood Zone Distribution"
#| fig-width: 8
#| fig-height: 5

if(nrow(flood_zone_summary) > 0) {
  flood_zone_summary |>
    head(10) |>
    ggplot(aes(x = reorder(fema_fz, n), y = n)) +
    geom_col(fill = hda_colors["coral"], alpha = 0.8) +
    geom_text(
      aes(label = n), 
      hjust = -0.2, 
      size = 3.5,
      family = "Lato",
      color = "#555555"
    ) +
    coord_flip() +
    labs(
      title = "Properties by Flood Zone Classification",
      x = "FEMA Flood Zone",
      y = "Number of Properties"
    )
}
```

### QCT & DDA Status {#sec-qct}
```{r qct-analysis}
#| label: qct-summary

qct_summary <- analysis_subset |>
  summarise(
    total_properties = n(),
    in_qct = sum(qct == 1, na.rm = TRUE),
    not_in_qct = sum(qct == 0, na.rm = TRUE),
    qct_percentage = sum(qct == 1, na.rm = TRUE) / n() * 100,
    in_dda = sum(dda == 1, na.rm = TRUE),
    dda_percentage = sum(dda == 1, na.rm = TRUE) / n() * 100
  )
```

**`r qct_summary$in_qct`** properties (`r round(qct_summary$qct_percentage, 1)`%) are located in Qualified Census Tracts, making them eligible for enhanced LIHTC tax credits.
```{r}
#| label: fig-qct
#| fig-cap: "QCT and DDA Status"
#| fig-width: 7
#| fig-height: 4

tibble(
  Status = c("In QCT", "Not in QCT", "In DDA", "Not in DDA"),
  Count = c(qct_summary$in_qct, qct_summary$not_in_qct, 
            qct_summary$in_dda, qct_summary$total_properties - qct_summary$in_dda),
  Type = c("QCT", "QCT", "DDA", "DDA")
) |>
  ggplot(aes(x = Type, y = Count, fill = Status)) +
  geom_col(position = "dodge", alpha = 0.8) +
  geom_text(
    aes(label = Count),
    position = position_dodge(width = 0.9),
    vjust = -0.5,
    family = "Lato",
    size = 3.5
  ) +
  scale_fill_manual(values = c(
    "In QCT" = hda_colors["blue"],
    "Not in QCT" = "#d0d0d0",
    "In DDA" = hda_colors["green"],
    "Not in DDA" = "#d0d0d0"
  )) +
  labs(
    title = "LIHTC Eligibility: QCT and DDA Status",
    x = "",
    y = "Number of Properties",
    fill = ""
  ) +
  theme(legend.position = "bottom")
```

## Development Opportunity Assessment
```{r opportunity-assessment}
#| label: opportunity-matrix

property_profile <- analysis_subset |>
  filter(!is.na(lan_val)) |>
  mutate(
    has_environmental_constraint = (wet_perc > 10) | 
      (fema_fz %in% c("A", "AE", "AO", "AH", "V", "VE")),
    developable = (rgisacre >= 1) & (!has_environmental_constraint),
    land_value_per_acre = if_else(rgisacre > 0, lan_val / rgisacre, NA_real_)
  ) |>
  select(
    uid, pid, congr_name, 
    attendance_2023, members_2023, attendance_avg,
    lan_val, land_value_per_acre, rgisacre, deed_acres,
    zon, zon_desc, zon_type,
    qct, dda, 
    wet_perc, fema_fz, fema_nri,
    has_environmental_constraint, developable,
    sadd, scity, scounty, sstate, szip,
    lat, lon
  ) |>
  arrange(desc(developable), desc(lan_val))

opportunity_matrix <- property_profile |>
  summarise(
    high_opportunity = sum(qct == 1 & rgisacre >= 1 & !has_environmental_constraint, na.rm = TRUE),
    medium_opportunity = sum((qct == 1 | dda == 1) & rgisacre >= 0.5 & rgisacre < 1, na.rm = TRUE),
    constrained_properties = sum(has_environmental_constraint == TRUE, na.rm = TRUE),
    small_parcels = sum(rgisacre < 0.5, na.rm = TRUE)
  )
```

### Opportunity Classification
```{r}
#| label: tbl-opportunities
#| tbl-cap: "Development Opportunity Matrix"

opportunity_matrix |>
  pivot_longer(everything(), names_to = "Category", values_to = "Count") |>
  mutate(
    Category = case_when(
      Category == "high_opportunity" ~ "High Opportunity",
      Category == "medium_opportunity" ~ "Medium Opportunity",
      Category == "constrained_properties" ~ "Environmentally Constrained",
      Category == "small_parcels" ~ "Small Parcels (<0.5 acres)"
    ),
    Description = case_when(
      Category == "High Opportunity" ~ "QCT + ≥1 acre + no major constraints",
      Category == "Medium Opportunity" ~ "QCT/DDA + 0.5-1 acre",
      Category == "Environmentally Constrained" ~ "Flood zones or significant wetlands",
      Category == "Small Parcels (<0.5 acres)" ~ "Limited development potential"
    )
  ) |>
  gt() |>
  tab_style(
    style = list(
      cell_fill(color = scales::alpha(hda_colors["blue"], 0.2)),
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = Category == "High Opportunity")
  ) |>
  tab_style(
    style = cell_fill(color = scales::alpha(hda_colors["yellow"], 0.2)),
    locations = cells_body(rows = Category == "Medium Opportunity")
  ) |>
  tab_style(
    style = cell_text(
      font = "Roboto Slab",
      weight = "bold",
      color = hda_colors["blue"]
    ),
    locations = cells_column_labels()
  ) |>
  tab_options(
    table.font.names = "Lato",
    table.font.size = 11
  )
```
```{r}
#| label: fig-opportunities
#| fig-cap: "Development Opportunity Breakdown"
#| fig-width: 8
#| fig-height: 5

opportunity_matrix |>
  pivot_longer(everything(), names_to = "Category", values_to = "Count") |>
  mutate(
    Category = case_when(
      Category == "high_opportunity" ~ "High\nOpportunity",
      Category == "medium_opportunity" ~ "Medium\nOpportunity",
      Category == "constrained_properties" ~ "Environmentally\nConstrained",
      Category == "small_parcels" ~ "Small\nParcels"
    ),
    Category = factor(Category, levels = c(
      "High\nOpportunity", "Medium\nOpportunity", 
      "Environmentally\nConstrained", "Small\nParcels"
    )),
    color = c(hda_colors["blue"], hda_colors["yellow"], 
              hda_colors["coral"], "#cccccc")
  ) |>
  ggplot(aes(x = Category, y = Count, fill = color)) +
  geom_col(alpha = 0.8) +
  geom_text(
    aes(label = Count),
    vjust = -0.5,
    family = "Lato",
    size = 4,
    fontface = "bold"
  ) +
  scale_fill_identity() +
  labs(
    title = "Property Classification by Development Potential",
    x = "",
    y = "Number of Properties"
  ) +
  theme(legend.position = "none")
```

### Top Development Opportunities
```{r}
#| label: tbl-top-properties
#| tbl-cap: "Properties with Highest Development Potential"

property_profile |>
  filter(developable == TRUE) |>
  select(congr_name, attendance_2023, lan_val, rgisacre, qct, scity, scounty) |>
  head(10) |>
  gt() |>
  cols_label(
    congr_name = "Congregation",
    attendance_2023 = "2023 Attendance",
    lan_val = "Land Value",
    rgisacre = "Acres",
    qct = "QCT",
    scity = "City",
    scounty = "County"
  ) |>
  fmt_currency(columns = lan_val, decimals = 0) |>
  fmt_number(columns = rgisacre, decimals = 2) |>
  fmt_integer(columns = qct) |>
  tab_style(
    style = cell_text(
      font = "Roboto Slab",
      weight = "bold",
      color = hda_colors["blue"]
    ),
    locations = cells_column_labels()
  ) |>
  tab_style(
    style = cell_fill(color = scales::alpha(hda_colors["green"], 0.15)),
    locations = cells_body(columns = qct, rows = qct == 1)
  ) |>
  tab_options(
    table.font.names = "Lato",
    table.font.size = 11
  )
```

## Attendance Profile
```{r attendance-profile}
#| label: attendance-context

attendance_context <- analysis_subset |>
  filter(!is.na(attendance_2023)) |>
  summarise(
    mean_attendance = mean(attendance_2023, na.rm = TRUE),
    median_attendance = median(attendance_2023, na.rm = TRUE),
    zero_attendance = sum(attendance_2023 == 0, na.rm = TRUE),
    attendance_1_10 = sum(attendance_2023 > 0 & attendance_2023 <= 10, na.rm = TRUE),
    attendance_11_20 = sum(attendance_2023 > 10 & attendance_2023 <= 20, na.rm = TRUE),
    attendance_21_29 = sum(attendance_2023 > 20 & attendance_2023 < 30, na.rm = TRUE),
    avg_members = mean(members_2023, na.rm = TRUE),
    avg_plate_pledge = mean(plate_pledge_2023, na.rm = TRUE)
  )
```

::: {.callout-tip}
## Attendance Summary

Average 2023 attendance for properties in this analysis: **`r round(attendance_context$mean_attendance, 1)`**

The distribution shows:

- Zero attendance: `r attendance_context$zero_attendance` properties
- 1-10 attendees: `r attendance_context$attendance_1_10` properties  
- 11-20 attendees: `r attendance_context$attendance_11_20` properties
- 21-29 attendees: `r attendance_context$attendance_21_29` properties

:::

```{r}
#| label: fig-attendance
#| fig-cap: "Attendance Distribution"
#| fig-width: 7
#| fig-height: 4

tibble(
  Category = c("0", "1-10", "11-20", "21-29"),
  Count = c(
    attendance_context$zero_attendance,
    attendance_context$attendance_1_10,
    attendance_context$attendance_11_20,
    attendance_context$attendance_21_29
  )
) |>
  mutate(Category = factor(Category, levels = c("0", "1-10", "11-20", "21-29"))) |>
  ggplot(aes(x = Category, y = Count)) +
  geom_col(fill = hda_colors["blue"], alpha = 0.8) +
  geom_text(
    aes(label = Count),
    vjust = -0.5,
    family = "Lato",
    size = 4
  ) +
  labs(
    title = "Properties by 2023 Attendance Range",
    x = "Sunday Attendance",
    y = "Number of Properties"
  )
```

## Conclusions

This analysis identified **`r opportunity_matrix$high_opportunity` high-opportunity properties** that combine favorable location (QCT eligibility), sufficient acreage (≥1 acre), and minimal environmental constraints. An additional **`r opportunity_matrix$medium_opportunity` medium-opportunity properties** warrant further investigation.

### Key Findings

- **Total Land Value:** `r dollar(land_value_summary$total_land_value)` across `r nrow(analysis_subset)` properties
- **Total Acreage:** `r round(acreage_summary$total_acres, 1)` acres available
- **LIHTC Eligibility:** `r qct_summary$in_qct` properties (`r round(qct_summary$qct_percentage, 1)`%) in QCT zones
- **Development Ready:** `r opportunity_matrix$high_opportunity` properties meet all criteria for immediate development consideration

### Recommendations

1. **Priority Focus:** Concentrate initial outreach on the `r opportunity_matrix$high_opportunity` high-opportunity properties
2. **Secondary Review:** Conduct site visits for medium-opportunity properties to assess actual constraints
3. **Congregation Support:** Develop resources for congregations to understand development options
4. **Financial Analysis:** Model pro forma scenarios for top 10 properties to determine feasibility
```{r export}
#| label: export-data
#| include: false

write_csv(property_profile, "verep_analysis_results.csv")
```

---

::: {.content-visible when-format="html"}

*Analysis completed: `r Sys.Date()`*

*Data exported to: `verep_analysis_results.csv`*

*For PDF version, render with `quarto render document.qmd --to pdf`*

:::

::: {.content-visible when-format="pdf"}

*Analysis completed: `r Sys.Date()`* | *Data exported to: verep_analysis_results.csv*

:::