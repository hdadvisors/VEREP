```{r}
#| include: false
source("R/common.R")
```


# Background & Data Sources

## VEREP Parcel Dataset

This analysis utilizes the Virginia Episcopal Real Estate Portfolio (VEREP) parcel dataset, compiled by CGS Consultants. The dataset includes:

```{r verep-count, echo=FALSE, results='asis'}
cat("- **", nrow(property_profile), " parcels** across Virginia\n", sep = "")
```

-   Comprehensive property characteristics (size, use, zoning)
-   Environmental constraints (floodplains, wetlands, easements)
-   Location metrics (walkability, transit access)
-   Market indicators (median income, demographics)

## Congregation Statistics (2014-2023)

Financial and membership data provides context on congregation health:

-   Sunday attendance trends
-   Membership changes
-   Plate & pledge revenue
-   10-year trend analysis

::: callout-note
## Data Quality Note

Not all properties have associated congregation data. Properties without congregation information received neutral scores in the financial need category.
:::

## Data Quality Issues

Of the 104 properties analyzed with fewer than 30 Sunday attendees, 101 (97.1%) have incomplete data — meaning they are missing at least one of the six key development metrics (land value, acreage, wetland coverage, flood zone, QCT status, or zoning). This high rate reflects broader data quality challenges identified in CGS's initial VEREP study, where many congregations share properties or fail to report complete address and parcel information.

Additionally, 369 of 790 total VEREP properties (47%) could not be matched to congregation attendance records — either because no congregation was assigned in the source data or because naming inconsistencies prevented a successful join.

While environmental constraint data (wetlands, flood zones) accounts for much of the missing information, 15 properties (14.4%) are missing land value entirely, limiting our ability to assess their financial potential. The breakdown below classifies these data gaps to help prioritize follow-up research. Once complete, these properties can be more precisely evaluated for development opportunities.

```{r data-quality-stats, echo=FALSE}

# Calculate summary stats
total_props <- nrow(property_profile)

# Incomplete data (data_completeness < 6)
incomplete_properties <- property_profile |>
  filter(data_completeness < 6)
incomplete_count <- nrow(incomplete_properties)

# Missing land value
missing_land_value <- sum(property_profile$missing_land_value, na.rm = TRUE)

# Unmatched properties summary
total_unmatched <- nrow(no_congregation) + nrow(no_match)

# Create summary table
summary_stats <- tibble(
  Metric = c(
    "Total properties analyzed (<30 attendance)",
    "Properties with incomplete data (score < 6/6)",
    "Properties missing land value",
    "VEREP properties not matched to congregation"
  ),
  Value = c(
    total_props,
    paste0(incomplete_count, " (", round(incomplete_count/total_props*100, 1), "%)"),
    paste0(missing_land_value, " (", round(missing_land_value/total_props*100, 1), "%)"),
    paste0(total_unmatched, " (of 790 total VEREP properties)")
  )
)

# Display as formatted table
summary_stats |>
  kable(align = c("l", "r")) |>
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE,
                position = "left") |>
  column_spec(1, bold = TRUE, width = "25em") |>
  column_spec(2, width = "12em")
```

```{r no-coords-warning, echo=FALSE, results='asis'}

# geocoding missing addresses here? 
```

```{r other-issues, echo=FALSE}
# Calculate missing data breakdown
missing_breakdown <- incomplete_properties |>
  summarise(
    missing_land_value = sum(missing_land_value, na.rm = TRUE),
    missing_acreage = sum(missing_acreage, na.rm = TRUE),
    missing_wetland = sum(missing_wetland, na.rm = TRUE),
    missing_flood = sum(missing_flood, na.rm = TRUE),
    missing_qct = sum(missing_qct, na.rm = TRUE),
    missing_zoning = sum(missing_zoning, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "data_type", values_to = "count") |>
  mutate(
    data_type = str_remove(data_type, "missing_"),
    data_type = str_to_title(str_replace_all(data_type, "_", " "))
  ) |>
  arrange(desc(count))

# Calculate properties with address issues
props_with_incomplete_addr <- incomplete_properties |> 
  filter(is.na(sadd) | sadd == "" | grepl("UNASSIGNED|INCOMPLETE", sadd, ignore.case = TRUE)) |>
  nrow()

# Count address issues from unmatched data
unmatched_with_no_address <- no_match |>
  filter(is.na(sadd) | sadd == "") |>
  nrow()

address_issues <- props_with_incomplete_addr + unmatched_with_no_address

# Add Property Information row
missing_breakdown <- missing_breakdown |>
  add_row(
    data_type = "Property Information",
    count = address_issues
  ) |>
  arrange(desc(count))
```

```{r missing-data-chart, echo=FALSE, fig.height=4}
missing_breakdown |>
  filter(count > 0) |>  # Remove categories with no missing data
  ggplot(aes(x = reorder(data_type, count), y = count)) +
  geom_col(fill = "#e76f52", alpha = 0.8) +
  geom_text(aes(label = paste0(count, " (", round(count/nrow(incomplete_properties)*100, 1), "%)")), 
            hjust = -0.05, size = 3.5) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.25))) +
  labs(
    title = "Missing Data by Category",
    subtitle = paste0("Among ", nrow(incomplete_properties), " properties with incomplete data"),
    x = "",
    y = "Number of Properties"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", color = "#445ca9"),
    plot.subtitle = element_text(color = "#666666"),
    panel.grid.major.y = element_blank()
  )
```


### Data Matching Summary

Of the 790 properties in the VEREP dataset, 421 (53%) successfully matched to congregation attendance records. The remaining 369 properties (47%) did not match, falling into three categories:

| Category | Count | Description |
|----------|------:|-------------|
| No congregation assigned | 272 | Property has no `congr_name` value in VEREP — likely auxiliary parcels, vacant lots, or properties not yet mapped to a congregation |
| City mismatch | 37 | Congregation name exists in attendance data but under a different city — potential matches requiring manual review |
| Name not found | 11 | Congregation name does not appear in attendance data — possibly closed churches, different diocese, or spelling variants |


Note: The 37 city mismatch properties represent the most actionable data quality issue. These could be recovered with a manual crosswalk or by relaxing the city requirement for unique congregation names. The 11 missing names warrant investigation to determine if these congregations have been closed, merged, or are recorded under alternate names.