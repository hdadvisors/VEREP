```{r}
#| include: false
source("R/common.R")
```


# Background & Data Sources

## VEREP Parcel Dataset

This analysis utilizes the Virginia Episcopal Real Estate Portfolio (VEREP) parcel dataset, compiled by CGS Consultants. The dataset (originally 790 parcels) was further filtered to look at parcels/properties owned by congregations or the diocese and with small congregations to total:

```{r verep-count, echo=FALSE, results='asis'}
cat("- **", nrow(property_profile), " parcels** across Virginia\n", sep = "")
```

-   Comprehensive property characteristics (size, use, zoning)
-   Environmental constraints (floodplains, wetlands, easements)
-   Location metrics (walkability, transit access)
-   Market indicators (median income, demographics)

## Congregation Statistics (2014-2023)

This analysis also includes congregation statistics from the VEREP GIS webtool. Financial and membership data provides context on congregation health:

-   Sunday attendance trends
-   Membership changes
-   Plate & pledge revenue
-   10-year trend analysis

::: callout-note
## Data Quality Note

Not all properties have associated congregation data. Properties without congregation information received neutral scores in the financial need category.
:::

## Data Quality Issues

Of the 104 parcels analyzed, 101 (97.1%) have incomplete data — meaning they are missing at least one of the six key development metrics (land value, acreage, wetland coverage, flood zone, QCT status, or zoning). This high rate reflects broader data quality challenges identified in CGS's initial VEREP study.

While environmental constraint data (wetlands, flood zones) accounts for much of the missing information, 15 properties (14.4%) are missing land value, limiting our ability to assess their financial potential. The breakdown below classifies these data gaps to help prioritize follow-up research. Once these are verified, these properties can be more precisely evaluated for development opportunities.

```{r other-issues, echo=FALSE}

# Create incomplete_properties - properties missing key data
incomplete_properties <- property_profile |>
  filter(
    missing_land_value == TRUE |
    missing_acreage == TRUE |
    missing_wetland == TRUE |
    missing_flood == TRUE |
    missing_qct == TRUE |
    missing_zoning == TRUE
  )

# Calculate missing data breakdown
missing_breakdown <- incomplete_properties |>
  summarise(
    missing_land_value = sum(missing_land_value, na.rm = TRUE),
    missing_acreage = sum(missing_acreage, na.rm = TRUE),
    missing_wetland = sum(missing_wetland, na.rm = TRUE),
    missing_flood = sum(missing_flood, na.rm = TRUE),
    missing_qct = sum(missing_qct, na.rm = TRUE),
    missing_zoning = sum(missing_zoning, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "data_type", values_to = "count") |>
  mutate(
    data_type = str_remove(data_type, "missing_"),
    data_type = str_to_title(str_replace_all(data_type, "_", " "))
  ) |>
  arrange(desc(count))

# Calculate properties with address issues
props_with_incomplete_addr <- incomplete_properties |> 
  filter(is.na(sadd) | sadd == "" | grepl("UNASSIGNED|INCOMPLETE", sadd, ignore.case = TRUE)) |>
  nrow()

# Count address issues from unmatched data
unmatched_with_no_address <- no_match |>
  filter(is.na(sadd) | sadd == "") |>
  nrow()

address_issues <- props_with_incomplete_addr + unmatched_with_no_address

# Add Property Information row
missing_breakdown <- missing_breakdown |>
  add_row(
    data_type = "Property Information",
    count = address_issues
  ) |>
  arrange(desc(count))
```

```{r missing-data-chart, echo=FALSE, fig.height=4}
missing_breakdown |>
  filter(count > 0) |>  # Remove categories with no missing data
  ggplot(aes(x = reorder(data_type, count), y = count)) +
  geom_col(fill = "#e76f52", alpha = 0.8) +
  geom_text(aes(label = paste0(count, " (", round(count/nrow(incomplete_properties)*100, 1), "%)")), 
            hjust = -0.05, size = 3.5) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.25))) +
  labs(
    title = "Missing Data by Category",
    subtitle = paste0("Among properties with incomplete data"),
    x = "",
    y = "Number of Properties"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", color = "#445ca9"),
    plot.subtitle = element_text(color = "#666666"),
    panel.grid.major.y = element_blank()
  )
```

## Addressing Data Gaps Through Enhanced Assessment

In the interim, we attempted to use other data present to elucidate these gaps.

### The QCT Data Challenge

Qualified Census Tract (QCT) designation applied to zero properties in this portfolio, rendering it useless for market assessment. We replaced QCT with median income and five-year household income growth forecasts from census tract data. Properties in high-income, high-growth areas score highest (90-95 points), while those in declining markets score lower (35-40 points). This approach uses actual market conditions at each property location rather than federal designations that proved inapplicable to small, rural congregations.

### The Wetland Data Challenge

The most significant data quality issue emerged in environmental constraint assessment: **97% of properties lacked wetland coverage data** from the National Wetlands Inventory. This critical gap meant that relying solely on wetland percentages would fail to identify environmentally constrained properties, potentially overestimating development opportunities across the portfolio.

Rather than impute wetland data or exclude these properties from analysis, we implemented a **multi-faceted constraint assessment framework** using complementary data sources with comprehensive coverage:

**1 Historic District Designation**

We incorporated National Register Historic District boundaries from the Virginia Department of Historic Resources. This revealed that **45% of the 104 properties** (n=47) are located within historic districts—a finding with significant implications for development feasibility. Properties in historic districts face additional regulatory requirements including design review processes, material restrictions, and extended approval timelines. Historic designation doesn't prohibit development but typically adds 15-25% to project costs and 3-6 months to development schedules. These properties receive a **-25 point penalty** in development scoring to reflect added complexity.

**2 FEMA National Risk Index**

The FEMA National Risk Index provides comprehensive natural hazard assessment beyond flood zones alone, incorporating risks from hurricanes, tornadoes, severe storms, wildfires, earthquakes, and other hazards. This multi-hazard approach captures the full spectrum of climate and disaster risks that affect development feasibility, construction costs, and insurance requirements.

Among the 104 properties:
- **Very Low or Relatively Low risk**: 79% (minimal concerns)
- **Relatively Moderate risk**: 32% (manageable with standard precautions, -15 point penalty)
- **Relatively High risk**: 12% (significant mitigation required, -40 point penalty)
- **Very High risk**: <1% (likely deal-breaker, -50 point penalty)

**Combined Assessment Impact**

This enhanced screening framework identified environmental and regulatory constraints affecting **17 properties** (16%) that would have been missed using wetland data alone. The addition of historic district data proved particularly valuable: among the 36 goldilocks opportunities (0.5-5 acres), **16 properties** (44%) carry historic designation, providing crucial context for development planning and timeline expectations.

For the small subset of properties with wetland data available (11%), we retained this information and applied it alongside historic and hazard assessments. Properties with multiple major constraints (e.g., flood zone + high hazard risk, or significant wetlands + flood zone) receive compounded penalties (up to -75 points), reflecting cumulative impacts on development feasibility.

### Addressing Missing Property Information 

Eleven properties lacked specific street addresses in county parcel records, listed instead as "UNASSIGNED" or missing entirely. To enable spatial analysis and mapping, we employed the Geocodio API to generate approximate coordinates based on available city and county information.

**Geocoding Results:**
- **Success rate**: 100% (11/11 properties geocoded)
- **Accuracy**: Medium (0.54) representing city-center approximations
- **Location**: All 11 properties geocoded to West Point, King William County
- **Congregations**: Two congregations affected (St. Pauls Church, St. Johns Episcopal Church)

**Analysis Impact:**

The geocoding process successfully provided coordinates for mapping while revealing that all 11 properties are **small parcels under 0.5 acres**—below the goldilocks development threshold. These properties were appropriately classified as "Small Parcel" regardless of address precision, meaning the city-center coordinate approximations do not affect development opportunity identification. All 104 properties now have sufficient location data for spatial analysis and visualization, with no impact on the integrity of top opportunities rankings.

**Remaining Data Needs:**

Following wetland data supplementation and geocoding remediation, **15 properties** (14.4%) lacked assessed land values from county records. Rather than excluding these properties or pursuing individual county assessor verification, which would be more reliable but an added task, we applied a conservative estimation method using existing census tract-level housing market data.

#### Land Value Estimation Method:

Properties without assessed land values were estimated using census tract median home values, assuming land represents approximately 25% of total residential property value in the area. This ratio aligns with typical land-to-improvement value relationships in suburban and rural Virginia markets. The formula applied:
```
Estimated Land Value = (Census Tract Median Home Value × 0.25) × Property Acreage
```

This method provides order-of-magnitude values sufficient for preliminary opportunity screening while flagging properties for detailed appraisal before advancing to feasibility analysis. All estimated values are clearly marked in the dataset with the source noted as "Estimated from Area Median" rather than "County Assessor."

**Coverage Achievement:**
- Properties with direct assessor land values: 89/104 (85.6%)
- Properties with estimated land values: 15/104 (14.4%)
- Total properties with usable land value data: **104/104 (100%)**

No properties require manual follow-up for land value data, though the 15 estimated values should be verified through formal appraisal during due diligence for any properties advancing to development.

### Before and after enhanced assessment 

```{r}
# Calculate missing data breakdown - ORIGINAL GAPS
missing_breakdown_original <- property_profile |>
  summarise(
    `Land Value` = sum(is.na(lan_val), na.rm = TRUE),
    `Wetland Data` = sum(is.na(wet_perc), na.rm = TRUE),
    `Flood Zone` = sum(is.na(fema_fz) | fema_fz == "", na.rm = TRUE),
    `Property Address` = sum(is.na(sadd) | sadd == "" | grepl("UNASSIGNED", sadd, ignore.case = TRUE), na.rm = TRUE),
    `Zoning` = sum(is.na(zon) | zon == "", na.rm = TRUE),
    `QCT Status` = sum(is.na(qct), na.rm = TRUE),
    `Market Indicators` = 104  # All properties lacked effective market scoring (QCT applied to 0)
  ) |>
  pivot_longer(everything(), names_to = "data_type", values_to = "original_missing")

# Calculate what remains AFTER enhancements
missing_breakdown_enhanced <- property_profile |>
  summarise(
    `Land Value` = sum(is.na(estimated_land_value), na.rm = TRUE),  # Should be 0
    `Wetland Data` = 0,  # Supplemented with historic + FEMA NRI
    `Flood Zone` = sum(is.na(fema_fz) | fema_fz == "", na.rm = TRUE),
    `Property Address` = 0,  # All geocoded
    `Zoning` = sum(is.na(zon) | zon == "", na.rm = TRUE),
    `QCT Status` = sum(is.na(qct), na.rm = TRUE),
    `Market Indicators` = 0  # All properties now have medinc + hhi_g_n5
  ) |>
  pivot_longer(everything(), names_to = "data_type", values_to = "still_missing")

# Combine for comparison
missing_comparison <- missing_breakdown_original |>
  left_join(missing_breakdown_enhanced, by = "data_type") |>
  mutate(
    addressed = original_missing - still_missing,
    pct_addressed = round(addressed / original_missing * 100, 1)
  ) |>
  arrange(desc(addressed))

# Create comparison visualization
missing_comparison |>
  filter(original_missing > 0) |>  # Only show categories with gaps
  pivot_longer(cols = c(still_missing, addressed), 
               names_to = "status", 
               values_to = "count") |>
  mutate(
    status = factor(status, 
                    levels = c("still_missing", "addressed"),
                    labels = c("Remaining Gap", "Addressed by Enhancement"))
  ) |>
  ggplot(aes(x = reorder(data_type, original_missing), y = count, fill = status)) +
  geom_col() +
  geom_text(data = missing_comparison |> filter(original_missing > 0),
            aes(x = data_type, y = original_missing, label = original_missing),
            inherit.aes = FALSE,
            hjust = -0.2, size = 3.5, fontface = "bold") +
  coord_flip() +
  scale_fill_manual(
    values = c("Remaining Gap" = "#e76f52", 
               "Addressed by Enhancement" = "#8baeaa"),
    name = ""
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.20))) +
  labs(
    title = "Data Quality Improvements Through Enhanced Assessment",
    subtitle = "Original gaps vs. after enhanced market scoring, constraint assessment, estimation, and geocoding",
    x = "",
    y = "Number of Properties"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", color = "#445ca9"),
    plot.subtitle = element_text(color = "#666666", size = 10),
    panel.grid.major.y = element_blank(),
    legend.position = "top"
  )
```

```{r}
# Create summary table showing impact
enhancement_summary <- missing_comparison |>
  filter(addressed > 0) |>
  mutate(
    Enhancement = case_when(
      data_type == "Market Indicators" ~ "Median income + 5-year household income growth forecasts",
      data_type == "Wetland Data" ~ "Historic districts + FEMA National Risk Index",
      data_type == "Land Value" ~ "Census tract median home value estimation",
      data_type == "Property Address" ~ "Geocodio API geocoding",
      TRUE ~ ""
    ),
    Explanation = case_when(
      data_type == "Market Indicators" ~ "Replaced ineffective QCT designation (0 properties qualified) with actual market conditions",
      data_type == "Wetland Data" ~ "Multi-faceted constraint framework capturing regulatory and hazard risks",
      data_type == "Land Value" ~ "Conservative estimation assuming land = 25% of residential property value",
      data_type == "Property Address" ~ "City-center approximations sufficient for small parcels excluded from top opportunities",
      TRUE ~ ""
    )
  ) |>
  select(
    `Data Category` = data_type,
    `Original Gap` = original_missing,
    `Addressed` = addressed,
    `Remaining` = still_missing,
    Enhancement,
    Explanation
  )

enhancement_summary |>
  kable(
    caption = "Data Enhancement Impact Summary",
    align = c("l", "r", "r", "r", "l", "l")
  ) |>
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE
  ) |>
  column_spec(3, bold = TRUE, color = "#8baeaa") |>
  column_spec(4, color = if_else(enhancement_summary$Remaining > 0, "#e76f52", "#666666"))
```


### Recommendation

The enhanced constraint assessment framework using historic districts and comprehensive hazard ratings provides robust environmental and regulatory screening despite limited wetland data. Properties identified as opportunities have been vetted against multiple constraint sources, providing confidence in their development potential. Future site-specific due diligence should include wetland delineation for properties advancing to development, particularly for the 89% of parcels without existing wetland assessments.