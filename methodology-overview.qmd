```{r}
source("R/common.R")
```


# Background & Data Sources

## VEREP Parcel Dataset

This analysis utilizes the Virginia Episcopal Real Estate Portfolio (VEREP) parcel dataset, compiled by CGS Consultants. The dataset includes:

```{r verep-count, echo=FALSE, results='asis'}
cat("- **", nrow(property_profile), " parcels** across Virginia\n", sep = "")
```

-   Comprehensive property characteristics (size, use, zoning)
-   Environmental constraints (floodplains, wetlands, easements)
-   Location metrics (walkability, transit access)
-   Market indicators (median income, demographics)

## Congregation Statistics (2014-2023)

Financial and membership data provides context on congregation health:

-   Sunday attendance trends
-   Membership changes
-   Plate & pledge revenue
-   10-year trend analysis

::: callout-note
## Data Quality Note

Not all properties have associated congregation data. Properties without congregation information received neutral scores in the financial need category.
:::

## Data Quality Issues

One of the issues identified by CGS's initial study was that a large number of congregations either had incomplete or inconsistent data; many congregations share properties or fail to appropriately report their permanent address. Their final output data, which was utilized for this development analysis, reflected this. While environmental constraints accounted for the majority of the missing data, many others contained incomplete property information. For a closer look, we separated and classified these attributes below. These properties can be more precisely assessed for development once they have greater data.

```{r data-quality-stats, echo=FALSE}

# Load the exported data from GIS Report.R
property_profile <- read_csv("data/output/verep_full_analysis.csv", show_col_types = FALSE)
attendance_context <- read_csv("data/output/verep_attendance_summary.csv", show_col_types = FALSE)
opportunity_matrix <- read_csv("data/output/verep_opportunity_matrix.csv", show_col_types = FALSE)
leadership_report <- read_csv("data/output/verep_top_opportunities.csv", show_col_types = FALSE)
data_followup <- read_csv("data/output/verep_data_needed.csv", show_col_types = FALSE)
incomplete_properties <- read_csv("data/output/incomplete_properties.csv", show_col_types = FALSE)
unassigned_addresses <- read_csv("data/output/unassigned_addresses.csv", show_col_types = FALSE)
shared_addresses <- read_csv("data/output/shared_addresses.csv", show_col_types = FALSE)
problem_matrix <- read_csv("data/output/problem_matrix_comprehensive.csv", show_col_types = FALSE)

# Calculate summary stats
total_props <- nrow(property_profile)
incomplete_data <- nrow(incomplete_properties)
missing_addresses <- sum(unassigned_addresses$num_unassigned)

# Create summary table
summary_stats <- tibble(
  Metric = c("Total properties analyzed",
             "Properties with incomplete data",
             "Properties with missing/unassigned addresses"),
  Value = c(total_props,
            paste0(incomplete_data, " (", round(incomplete_data/total_props*100, 1), "%)"),
            missing_addresses)
)

# Display as formatted table
summary_stats |>
  kable(align = c("l", "r")) |>
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE,
                position = "left") |>
  column_spec(1, bold = TRUE, width = "20em") |>
  column_spec(2, width = "10em")

```

```{r no-coords-warning, echo=FALSE, results='asis'}
no_coords_count <- sum(unassigned_addresses$has_coords == 0)

if(no_coords_count > 0) {
  cat("::: {.callout-warning}\n")
  cat("## Properties Without Coordinates\n")
  cat("**", no_coords_count, "** properties have neither valid addresses nor coordinates. These will require manual lookup using county tax records or additional dioses review.\n", sep = "")
  cat(":::\n")
}
```

```{r other-issues, echo=FALSE}
# Calculate missing data breakdown
missing_breakdown <- incomplete_properties |>
  summarise(
    missing_land_value = sum(missing_land_value),
    missing_acreage = sum(missing_acreage),
    missing_wetland = sum(missing_wetland),
    missing_flood = sum(missing_flood),
    missing_qct = sum(missing_qct),
    missing_zoning = sum(missing_zoning)
  ) |>
  pivot_longer(everything(), names_to = "data_type", values_to = "count") |>
  mutate(
    data_type = str_remove(data_type, "missing_"),
    data_type = str_to_title(str_replace_all(data_type, "_", " "))
  ) |>
  arrange(desc(count))

# Calculate properties with address issues using simple $ notation
props_with_incomplete_addr <- incomplete_properties$pin[
  is.na(incomplete_properties$sadd) | 
  incomplete_properties$sadd == "" | 
  incomplete_properties$sadd == "INCOMPLETE"
]

address_issues <- nrow(shared_addresses) + nrow(unassigned_addresses) + 
  nrow(incomplete_properties |> filter(is.na(sadd) | sadd == ""))

# Add Property Information row
missing_breakdown <- missing_breakdown |>
  add_row(
    data_type = "Property Information",
    count = address_issues
  ) |>
  arrange(desc(count))
```

```{r missing-data-chart, echo=FALSE, fig.height=4}
ggplot(missing_breakdown, aes(x = reorder(data_type, count), y = count)) +
  geom_col(fill = "#e76f52", alpha = 0.8) +
  geom_text(aes(label = count), hjust = -0.2, size = 4) +
  coord_flip() +
  labs(
    title = "Missing Data by Category",
    x = "",
    y = "Number of Properties"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", color = "#445ca9"),
    panel.grid.major.y = element_blank()
  )
```

------------------------------------------------------------------------

### Missing and Unassigned Addresses

The following congregations comprise the 19 "properties" without proper street addresses, making them difficult to verify or inspect for development. 3 of these congregations (comprising 14 of the total 19) had coordinates, which allowed for reverse geocoding to identify the likely address or zip code.

```{r unassigned-table, echo=FALSE}
unassigned_addresses |>
  select(congregation_name, num_unassigned, cities, has_coords) |>
  mutate(has_coords = if_else(has_coords > 0, "Yes", "No")) |>
  kable(
    col.names = c("Congregation", "# Unassigned Properties", "Cities", "Has Coordinates"),
    digits = 0
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  row_spec(which(unassigned_addresses$has_coords == 0), background = "#f8d7da")
```

```{r}
library(tidygeocoder)

needs_geocoding <- unassigned_addresses |>
  filter(!is.na(sample_lat) & !is.na(sample_lon))

geocoded_results <- needs_geocoding |>
  reverse_geocode(
    lat = sample_lat,
    long = sample_lon,
    method = "arcgis",
    full_results = FALSE
  )

# Save the geocoded addresses
write_csv(geocoded_results, "data/output/geocoded_unassigned_addresses.csv")

geocoded_results |>
  select(congregation_name, num_unassigned, cities, address) |>
  kable(
    col.names = c("Congregation", "# Properties", "Cities", "Geocoded Address")
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover"))

```

------------------------------------------------------------------------

### Shared Addresses

These properties have different congregations sharing the same street address, indicating potential shared facilities, rental arrangements, or data quality issues.

```{r shared-summary, echo=FALSE}
# Create summary from shared_addresses
shared_summary <- shared_addresses |>
  group_by(sadd, scity) |>
  summarise(
    num_congregations = n_distinct(congregation_name),
    congregations = paste(unique(congregation_name), collapse = " | "),
    total_attendance = sum(attendance_2023, na.rm = TRUE),
    .groups = 'drop'
  ) |>
  arrange(desc(num_congregations))

# Calculate stats for callout
unique_addresses <- n_distinct(shared_addresses$sadd)
unique_congregations <- n_distinct(shared_addresses$congregation_name)
```

```{r shared-callout, echo=FALSE, results='asis'}
cat("::: {.callout-note}\n")
cat("## Findings\n")
cat("**", unique_addresses, "** addresses are shared by multiple congregations, affecting **", unique_congregations, "** different congregations.\n", sep = "")
cat(":::\n")
```

**Properties sharing addresses may indicate:**

1.  **Ethnic/language congregations** sharing space (Korean, Vietnamese, Spanish services)
2.  **Church plants** using host congregation facilities
3.  **Rental arrangements** - one congregation renting to another
4.  **Merged congregations** - maintaining separate legal entities
5.  **Data quality issues** - duplicate records or address errors

```{r shared-table, echo=FALSE}
if(nrow(shared_summary) > 0) {
  shared_summary |>
    kable(
      col.names = c("Street Address", "City", "# Congregations", "Congregation Names", "Combined Attendance"),
      digits = 0
    ) |>
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
    column_spec(3, bold = TRUE) |>
    row_spec(which(shared_summary$num_congregations >= 3), background = "#d1ecf1")
} else {
  cat("âœ“ No shared addresses found\n")
}
```

------------------------------------------------------------------------

### Priority Issues Summary

```{r priority-summary, echo=FALSE}
# Categorize problems
problem_categories <- problem_matrix |>
  count(address_status) |>
  arrange(desc(n))
```

**Problem Distribution:**

```{r priority-table, echo=FALSE}
problem_categories |>
  kable(
    col.names = c("Issue Type", "# Congregations"),
    digits = 0
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  row_spec(which(grepl("Both", problem_categories$address_status)), 
           background = "#f8d7da", bold = TRUE)
```
