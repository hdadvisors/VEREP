# Property Portfolio Overview

```{r}
#| include: false
source("R/common.R")
```

## Portfolio Summary

```{r}
#| label: portfolio-metrics
#| results: asis
#| echo: false

# Calculate key metrics
total_properties <- nrow(property_profile)
total_acres <- sum(property_profile$area_acres, na.rm = TRUE)
avg_score <- mean(property_profile$development_score, na.rm = TRUE)
high_potential <- sum(property_profile$development_potential == "High", na.rm = TRUE)

cat("::: {layout-ncol=4}\n\n")

cat("::: {.callout-note appearance='minimal'}\n")
cat("## ", total_properties, "\n", sep = "")
cat("Total Parcels\n")
cat(":::\n\n")

cat("::: {.callout-tip appearance='minimal'}\n")
cat("## ", format(round(total_acres, 0), big.mark = ","), "\n", sep = "")
cat("Total Acres\n")
cat(":::\n\n")

cat("::: {.callout-warning appearance='minimal'}\n")
cat("## ", round(avg_score, 1), "\n", sep = "")
cat("Avg Development Score\n")
cat(":::\n\n")

cat("::: {.callout-important appearance='minimal'}\n")
cat("## ", high_potential, "\n", sep = "")
cat("High Potential Properties\n")
cat(":::\n\n")

cat(":::\n")
```

## Property Use Types

```{r}
#| label: fig-use-types
#| fig-cap: "Distribution of Properties by Primary Use"
#| fig-height: 5
#| echo: false

# Summarize use types
use_summary <- property_profile |>
  summarise(
    Church = sum(use_church, na.rm = TRUE),
    Parking = sum(use_parking, na.rm = TRUE),
    `Open Space` = sum(use_open_space, na.rm = TRUE),
    Residence = sum(use_residence, na.rm = TRUE),
    School = sum(use_school, na.rm = TRUE),
    Cemetery = sum(use_cemetery, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "Use Type", values_to = "Count") |>
  filter(Count > 0) |>
  arrange(desc(Count)) |>
  mutate(pct = Count / sum(Count) * 100)

ggplot(use_summary, aes(x = reorder(`Use Type`, Count), y = Count, fill = `Use Type`)) +
  geom_col() +
  geom_text(aes(label = paste0(Count, " (", round(pct, 1), "%)")), 
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  scale_fill_manual(values = c(
    "Church" = "#445ca9",
    "Parking" = "#8baeaa",
    "Open Space" = "#e9ab3f",
    "Residence" = "#e76f52",
    "School" = "#9b59b6",
    "Cemetery" = "#7f8c8d"
  )) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  labs(
    title = "Properties by Use Type",
    x = "",
    y = "Number of Properties"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", color = "#445ca9"),
    panel.grid.major.y = element_blank(),
    legend.position = "none"
  )
```

## Development Score Distribution

Another way of looking at the data shared in the executive summary, one can see that the portfolio is largely balanced in terms of opportunity, if leaning slightly more towards the constrained and limited side of options.

```{r}
#| label: fig-score-distribution
#| fig-cap: "Distribution of Development Scores Across Portfolio"
#| fig-height: 4
#| echo: false

tier_summary <- scored_parcels |>
  count(development_potential) |>
  mutate(
    pct = n / sum(n) * 100,
    label = paste0(n, " (", round(pct, 0), "%)"),
    potential_order = factor(development_potential, 
                             levels = c("High", "Moderate", "Constrained", "Limited"))
  ) |>
  arrange(potential_order)

ggplot(tier_summary, aes(x = "", y = n, fill = potential_order)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            color = "white", fontface = "bold", size = 4) +
  scale_fill_manual(
    values = c(
      "High" = "#445ca9",
      "Moderate" = "#8baeaa",
      "Constrained" = "#e9ab3f",
      "Limited" = "#e76f52"
    )
  ) +
  labs(fill = "Development Potential") +
  theme_void(base_size = 12) +
  theme(
    legend.position = "bottom"
  ) +
  guides(fill = guide_legend(nrow = 1))
```

## Property Size vs Development Score

```{r}
#| label: fig-size-vs-score
#| fig-cap: "Development Scores by Property Size Category"
#| fig-height: 4
#| echo: false

scored_parcels |>
  mutate(
    size_category = case_when(
      area_acres < 1 ~ "< 1 acre",
      area_acres < 5 ~ "1–5 acres",
      area_acres < 10 ~ "5–10 acres",
      area_acres < 25 ~ "10–25 acres",
      TRUE ~ "25+ acres"
    ),
    size_category = factor(size_category, 
                           levels = c("< 1 acre", "1–5 acres", "5–10 acres", "10–25 acres", "25+ acres")),
    development_potential = factor(development_potential,
                                   levels = c("High", "Moderate", "Constrained", "Limited"))
  ) |>
  ggplot(aes(x = size_category, y = development_score, color = development_potential)) +
  geom_jitter(width = 0.2, alpha = 0.7, size = 3) +
  scale_color_manual(
    values = c(
      "High" = "#445ca9",
      "Moderate" = "#8baeaa",
      "Constrained" = "#e9ab3f",
      "Limited" = "#e76f52"
    )
  ) +
  labs(
    x = "Parcel Size",
    y = "Development Score",
    color = "Development Potential"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    panel.grid.major.x = element_blank()
  ) +
  guides(color = guide_legend(nrow = 1))
```

The most high and moderate-potential properties concentrate in the 1–5 acre "sweet spot," while parcels under 1 acre face inherent limitations and the largest sites show more constraints. This indicates that mid-sized properties offer the clearest path to development, although some larger parcels show strong opportunities in other metrics.

## Summary Metrics

::: {.panel-tabset}

### By County

```{r}
#| label: tbl-by-county
#| tbl-cap: "Property Distribution by County"
#| echo: false

county_summary <- property_profile |>
  group_by(scounty) |>
  summarise(
    properties = n(),
    total_acres = sum(area_acres, na.rm = TRUE),
    avg_score = mean(development_score, na.rm = TRUE),
    high_potential = sum(development_potential == "High", na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(desc(high_potential)) |>
  slice_head(n = 15)

county_summary |>
  mutate(
    total_acres = round(total_acres, 1),
    avg_score = round(avg_score, 1)
  ) |>
  kable(
    col.names = c("County", "Parcels", "Total Acres", "Avg Score", "# High Potential"),
    align = c("l", "r", "r", "r", "r")
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  row_spec(0, bold = TRUE, background = "#445ca9", color = "white")
```

### By Use Type

```{r}
#| label: tbl-by-use
#| tbl-cap: "Property Statistics by Use Type"
#| echo: false

use_stats <- property_profile |>
  summarise(
    `Church Properties` = list(c(
      n = sum(use_church, na.rm = TRUE),
      acres = sum(area_acres[use_church], na.rm = TRUE),
      score = mean(development_score[use_church], na.rm = TRUE)
    )),
    `Parking Properties` = list(c(
      n = sum(use_parking, na.rm = TRUE),
      acres = sum(area_acres[use_parking], na.rm = TRUE),
      score = mean(development_score[use_parking], na.rm = TRUE)
    )),
    `Open Space` = list(c(
      n = sum(use_open_space, na.rm = TRUE),
      acres = sum(area_acres[use_open_space], na.rm = TRUE),
      score = mean(development_score[use_open_space], na.rm = TRUE)
    ))
  )

# Create cleaner summary table
use_type_summary <- tibble(
  `Use Type` = c("Church", "Parking", "Open Space", "Residence", "School", "Cemetery"),
  Count = c(
    sum(property_profile$use_church, na.rm = TRUE),
    sum(property_profile$use_parking, na.rm = TRUE),
    sum(property_profile$use_open_space, na.rm = TRUE),
    sum(property_profile$use_residence, na.rm = TRUE),
    sum(property_profile$use_school, na.rm = TRUE),
    sum(property_profile$use_cemetery, na.rm = TRUE)
  ),
  `Avg Size (Acres)` = c(
    mean(property_profile$area_acres[property_profile$use_church], na.rm = TRUE),
    mean(property_profile$area_acres[property_profile$use_parking], na.rm = TRUE),
    mean(property_profile$area_acres[property_profile$use_open_space], na.rm = TRUE),
    mean(property_profile$area_acres[property_profile$use_residence], na.rm = TRUE),
    mean(property_profile$area_acres[property_profile$use_school], na.rm = TRUE),
    mean(property_profile$area_acres[property_profile$use_cemetery], na.rm = TRUE)
  ),
  `Avg Dev Score` = c(
    mean(property_profile$development_score[property_profile$use_church], na.rm = TRUE),
    mean(property_profile$development_score[property_profile$use_parking], na.rm = TRUE),
    mean(property_profile$development_score[property_profile$use_open_space], na.rm = TRUE),
    mean(property_profile$development_score[property_profile$use_residence], na.rm = TRUE),
    mean(property_profile$development_score[property_profile$use_school], na.rm = TRUE),
    mean(property_profile$development_score[property_profile$use_cemetery], na.rm = TRUE)
  )
) |>
  filter(Count > 0) |>
  arrange(desc(Count))

use_type_summary |>
  mutate(
    `Avg Size (Acres)` = round(`Avg Size (Acres)`, 2),
    `Avg Dev Score` = round(`Avg Dev Score`, 1)
  ) |>
  kable(align = c("l", "r", "r", "r")) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  row_spec(0, bold = TRUE, background = "#8baeaa", color = "white")
```

### High Potential

```{r}
#| label: tbl-high-potential
#| tbl-cap: "Top 20 High Development Potential Properties"
#| echo: false

library(kableExtra)

high_potential_props <- property_profile |>
  filter(development_potential %in% c("High", "Moderate")) |>
  arrange(desc(lan_val)) |>
  slice_head(n = 20)

if(nrow(high_potential_props) > 0) {
  high_potential_props |>
    mutate(Rank = row_number()) |>
    select(Rank, sadd, scity, scounty, rgisacre, lan_val, development_potential) |>
    kable(
      col.names = c("Rank", "Address", "City", "County", "Acres", "Land Value", "Tier"),
      digits = c(0, 0, 0, 0, 2, 0, 0),
      align = c("c", "l", "l", "l", "r", "r", "l")
    ) |>
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
    row_spec(0, bold = TRUE, background = "#445ca9", color = "white") |>
    row_spec(1:min(5, nrow(high_potential_props)), bold = TRUE)
} else {
  cat("No properties currently meet the High or Medium development potential criteria.")
}
```

```{r}
#| label: tbl-high-potential
#| tbl-cap: "Top 20 High Development Potential Properties"
#| echo: false

library(kableExtra)

high_potential_props <- property_profile |>
  filter(development_potential %in% c("High", "Moderate")) |>
  arrange(desc(development_score)) |>
  slice_head(n = 20)

if(nrow(high_potential_props) > 0) {
  high_potential_props |>
    mutate(Rank = row_number()) |>
    select(Rank, sadd, scity, scounty, rgisacre, development_score, development_potential) |>
    kable(
      col.names = c("Rank", "Address", "City", "County", "Acres", "Score", "Tier"),
      digits = c(0, 0, 0, 0, 2, 1, 0),
      align = c("c", "l", "l", "l", "r", "r", "l")
    ) |>
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
    row_spec(0, bold = TRUE, background = "#445ca9", color = "white") |>
    row_spec(1:min(5, nrow(high_potential_props)), bold = TRUE)
} else {
  cat("No properties currently meet the High or Moderate development potential criteria.")
}
```


### Development Tiers

```{r}
#| label: tbl-tiers
#| tbl-cap: "Summary by Development Tier"
#| echo: false

tier_summary <- property_profile |>
  group_by(development_potential) |>
  summarise(
    `# Properties` = n(),
    `Total Acres` = round(sum(area_acres, na.rm = TRUE), 1),
    `Avg Acres` = round(mean(area_acres, na.rm = TRUE), 2),
    `Avg Score` = round(mean(development_score, na.rm = TRUE), 1),
    `Avg Walkability` = round(mean(walk_idx, na.rm = TRUE), 1),
    .groups = "drop"
  ) |>
  arrange(desc(`Avg Score`))

tier_summary |>
  kable(
    col.names = c("Development Tier", "# Parcels", "Total Acres", "Avg Acres", "Avg Score", "Avg Walkability"),
    align = c("l", "r", "r", "r", "r", "r")
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover")) |>
  row_spec(0, bold = TRUE, background = "#e9ab3f", color = "white") |>
  row_spec(which(tier_summary$development_potential == "High Potential"), 
           background = "#d4edda")
```

:::

## Geographic Distribution

```{r}
#| label: fig-county-map
#| fig-cap: "Parcels by County (Top 15)"
#| fig-height: 5
#| echo: false

county_counts <- property_profile |>
  count(scounty, name = "n_properties") |>
  arrange(desc(n_properties)) |>
  slice_head(n = 15)

ggplot(county_counts, aes(x = reorder(scounty, n_properties), y = n_properties)) +
  geom_col(fill = "#445ca9", alpha = 0.8) +
  geom_text(aes(label = n_properties), hjust = -0.2, size = 3.5) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Top 15 Counties by Parcel Count",
    x = "",
    y = "Number of Parcels"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", color = "#445ca9"),
    panel.grid.major.y = element_blank()
  )
```
Each of these counties have multiple congregation parcels, with the highest concentration of small congregation parcels in King William and Stafford counties. 


## Congregation Health Indicators

```{r}
#| label: fig-attendance-pledge
#| fig-cap: "Congregation Health and Financial Need"
#| fig-height: 5
#| echo: false 

plot_data <- property_profile |>
  filter(!is.na(avg_attendance), !is.na(avg_pledge), 
         avg_attendance > 0, avg_pledge > 0) |>
  distinct(congregation_name, .keep_all = TRUE) |>
  mutate(
    financial_status = case_when(
      financial_need >= 2 ~ "Financial Need",
      TRUE ~ "Stable"
    )
  )

need_count <- sum(plot_data$financial_status == "Financial Need")
stable_count <- sum(plot_data$financial_status == "Stable")

ggplot(plot_data, aes(x = avg_attendance, y = avg_pledge / 1000, 
                      color = financial_status, shape = financial_status)) +
  geom_point(alpha = 0.7, size = 3) +
  scale_color_manual(values = c("Financial Need" = "#e76f52", "Stable" = "#445ca9")) +
  scale_shape_manual(values = c("Financial Need" = 17, "Stable" = 16)) +
  scale_x_log10() +
  scale_y_log10(labels = scales::dollar_format(suffix = "K")) +
  annotate("text", x = 10, y = 200, 
           label = paste0("Financial Need: ", need_count, " congregations"), 
           color = "#e76f52", fontface = "bold", hjust = 0, size = 3.5) +
  annotate("text", x = 10, y = 120, 
           label = paste0("Stable: ", stable_count, " congregations"), 
           color = "#445ca9", fontface = "bold", hjust = 0, size = 3.5) +
  labs(
    x = "Average Sunday Attendance",
    y = "Annual Plate & Pledge ($K)",
    color = "", shape = ""
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")
```
#| echo: false
#| results: asis

cat("::: {.callout-note}\n")
cat("## Understanding Financial Need\n")
cat("Financial need reflects **trajectory, not current resources**. Congregations flagged as 'Financial Need' may still report substantial annual giving, but their attendance and/or pledge revenue have declined significantly since 2014. These congregations are not in crisis today—but without intervention, they face an unsustainable path. Development partnerships offer an opportunity to stabilize finances while congregations remain viable, rather than waiting until resources are exhausted.\n")
cat(":::\n")

```{r}
#| echo: false

property_profile |>
  filter(financial_need >= 2, avg_pledge > 50000) |>
  distinct(congregation_name, .keep_all = TRUE) |>
  select(congregation_name, avg_attendance, avg_pledge, pct_change_attendance, pct_change_pledge) |>
  arrange(pct_change_attendance) |>
  mutate(
    avg_pledge = scales::dollar(avg_pledge),
    pct_change_attendance = paste0(round(pct_change_attendance, 1), "%"),
    pct_change_pledge = paste0(round(pct_change_pledge, 1), "%")
  ) |>
  kable(
    col.names = c("Congregation", "Avg Attendance", "Avg Pledge", "Attendance Change", "Pledge Change"),
    align = c("l", "r", "r", "r", "r")
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  row_spec(0, bold = TRUE, background = "#445ca9", color = "white")
```
These congregations show the largest declines in attendance and pledge over recent years.
