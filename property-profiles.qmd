# Property Profiles

```{r}
#| include: false
source("R/common.R")
```

## Overview

The following section provides detailed profiles for each of the top 10 development opportunities. Each profile includes:

-   Site characteristics and current use
-   Congregation context (where applicable)
-   Development opportunities and strategies
-   Key considerations and next steps

All of these priority sites would benefit from further analysis of housing needs in the area to determine best development fit.

```{css}
#| echo: false

.score-badge {
  background-color: #445ca9;
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: bold;
  display: inline-block;
  margin-right: 10px;
}

.score-badge.mid {
  background-color: #8baeaa;
}

.score-badge.low {
  background-color: #e9ab3f;
}

.metric-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  margin-bottom: 20px;
}

.metric-card {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  border-left: 4px solid #445ca9;
}

.metric-card.teal {
  border-left-color: #8baeaa;
}

.metric-card.red {
  border-left-color: #dc3545;
}

.metric-card.gold {
  border-left-color: #e9ab3f;
}

.metric-card.gray {
  border-left-color: #6c757d;
}

.metric-value {
  font-size: 1.8em;
  font-weight: bold;
  color: #445ca9;
}

.metric-value.teal {
  color: #8baeaa;
}

.metric-value.red {
  color: #dc3545;
}

.metric-value.gold {
  color: #e9ab3f;
}

.metric-value.gray {
  color: #6c757d;
}

.metric-label {
  color: #666;
  font-size: 0.9em;
}

.info-box {
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.status-box {
  padding: 15px;
  border-radius: 0 8px 8px 0;
  margin-bottom: 20px;
}

.status-box.warning {
  background: #fff3cd;
  border-left: 4px solid #dc3545;
}

.status-box.caution {
  background: #fff3cd;
  border-left: 4px solid #e9ab3f;
}

.status-box.success {
  background: #d4edda;
  border-left: 4px solid #28a745;
}

.section-header {
  color: #445ca9;
  border-bottom: 2px solid #445ca9;
  padding-bottom: 5px;
}

.steps-box {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.congregation-divider {
  border: none;
  border-top: 2px solid #e9ecef;
  margin: 40px 0;
}
```

```{r}
#| results: asis
#| echo: false

# Get high potential properties and group by congregation
high_potential_congregations <- property_profile %>%
  filter(development_potential %in% c("High")) %>%
  group_by(congregation_name) %>%
  summarise(
    site_city = first(site_city),
    site_county = first(site_county),
    n_parcels = n(),
    total_acres = sum(area_acres, na.rm = TRUE),
    total_value = sum(assessed_value, na.rm = TRUE),
    mean_dev_score = mean(development_score, na.rm = TRUE),
    max_dev_score = max(development_score, na.rm = TRUE),
    avg_attendance = first(avg_attendance),
    avg_members = first(avg_members),
    avg_pledge = first(avg_pledge),
    pct_change_pledge = first(pct_change_pledge),
    walkability_score = mean(walkability_score, na.rm = TRUE),
    parcel_ids = paste(pid, collapse = ", "),
    addresses = paste(unique(sadd), collapse = "; "),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_dev_score)) %>%
  mutate(rank = row_number()) %>%
  slice_head(n = 10)

# Function to create congregation profile with tabsets
create_congregation_profile <- function(row_num) {
  cong <- high_potential_congregations[row_num, ]
  
  if(nrow(cong) == 0) return(NULL)
  
  # Define score class
  score_class <- case_when(
    cong$mean_dev_score >= 70 ~ "",
    cong$mean_dev_score >= 60 ~ "mid",
    TRUE ~ "low"
  )
  
  # Attendance class
  att_class <- case_when(
    is.na(cong$avg_attendance) ~ "gray",
    cong$avg_attendance == 0 ~ "red",
    cong$avg_attendance < 20 ~ "gold",
    TRUE ~ "teal"
  )
  
  # Walkability class
  walk_class <- case_when(
    is.na(cong$walkability_score) ~ "gray",
    cong$walkability_score >= 15 ~ "teal",
    cong$walkability_score >= 10 ~ "gold",
    TRUE ~ "gray"
  )
  
  # Section header
  cat("\n\n## ", cong$rank, ". ", cong$congregation_name, " {.unnumbered}\n\n", sep = "")
  cat("**üìç ", cong$site_city, ", ", cong$site_county, " County**\n\n", sep = "")
  
  # Badges
  cat("[Dev Score: ", round(cong$mean_dev_score, 1), "]{.score-badge} ", sep = "")
  cat("[", cong$n_parcels, " Parcel", ifelse(cong$n_parcels > 1, "s", ""), "]{.score-badge}\n\n", sep = "")
  
  # Begin tabset
  cat("::: {.panel-tabset}\n\n")
  
  # ---- TAB 1: Overview ----
  cat("### Overview\n\n")
  
  cat("::: {.metric-grid}\n\n")
  
  cat("::: {.metric-card .teal}\n")
  cat("[", round(cong$total_acres, 2), "]{.metric-value .teal}\n\n", sep = "")
  cat("[Total Acres]{.metric-label}\n")
  cat(":::\n\n")
  
  cat("::: {.metric-card}\n")
  cat("[", scales::dollar(cong$total_value, accuracy = 1, scale = 1/1000), "K]{.metric-value}\n\n", sep = "")
  cat("[Assessed Value]{.metric-label}\n")
  cat(":::\n\n")
  
  cat("::: {.metric-card .", att_class, "}\n", sep = "")
  att_display <- ifelse(is.na(cong$avg_attendance), "N/A", round(cong$avg_attendance, 0))
  cat("[", att_display, "]{.metric-value .", att_class, "}\n\n", sep = "")
  cat("[Avg Attendance]{.metric-label}\n")
  cat(":::\n\n")
  
  cat("::: {.metric-card .", walk_class, "}\n", sep = "")
  walk_display <- ifelse(is.na(cong$walkability_score), "N/A", paste0(round(cong$walkability_score, 1), "/20"))
  cat("[", walk_display, "]{.metric-value .", walk_class, "}\n\n", sep = "")
  cat("[Walkability]{.metric-label}\n")
  cat(":::\n\n")
  
  cat(":::\n\n")
  
  # Multi-parcel callout
  if(cong$n_parcels > 1) {
    cat("::: {.callout-tip}\n")
    cat("## üìã Multi-Parcel Opportunity\n\n")
    cat("This congregation owns **", cong$n_parcels, " parcels** totaling **", 
        round(cong$total_acres, 2), " acres**, which may present consolidation or phased development opportunities.\n", sep = "")
    cat(":::\n\n")
  }
  
  # Congregation info box
  cat("::: {.info-box}\n")
  cat("**‚õ™ Congregation:** ", cong$congregation_name, "\n\n", sep = "")
  if(!is.na(cong$avg_members)) {
    cat("**üë• Members:** ", round(cong$avg_members, 0), "\n\n", sep = "")
  }
  if(!is.na(cong$avg_pledge)) {
    cat("**üí∞ Avg Pledge:** ", scales::dollar(cong$avg_pledge, accuracy = 1), "\n", sep = "")
  }
  cat(":::\n\n")
  
  # Walkability callout if score is notable
  if(!is.na(cong$walkability_score) && cong$walkability_score >= 15) {
    cat("::: {.callout-tip}\n")
    cat("## üö∂ Highly Walkable Location\n\n")
    cat("This site scores **", round(cong$walkability_score, 1), "/20** on walkability, ", sep = "")
    cat("supporting car-light households and potentially qualifying for reduced parking requirements in development.\n")
    cat(":::\n\n")
  } else if(!is.na(cong$walkability_score) && cong$walkability_score >= 10) {
    cat("::: {.callout-note}\n")
    cat("## üö∂ Moderate Walkability\n\n")
    cat("This site scores **", round(cong$walkability_score, 1), "/20** on walkability. ", sep = "")
    cat("Some transit access may support density considerations.\n")
    cat(":::\n\n")
  }
  
  # ---- TAB 2: Congregational Health ----
  cat("### Congregational Health\n\n")
  
  cat("#### Attendance Status {.section-header}\n\n")
  
  if(is.na(cong$avg_attendance)) {
    cat("::: {.status-box .caution}\n")
    cat("**üìä Data Unavailable**\n\n")
    cat("Attendance data is not available for this congregation.\n")
    cat(":::\n\n")
  } else if(cong$avg_attendance == 0) {
    cat("::: {.status-box .warning}\n")
    cat("**‚ö†Ô∏è Zero Average Attendance**\n\n")
    cat("This congregation reports no regular attendance despite having ", 
        round(cong$avg_members, 0), " members on the rolls. This may indicate:\n\n", sep = "")
    cat("- Functional inactivity requiring status clarification\n")
    cat("- Outdated membership records\n")
    cat("- A congregation ready for supported transition\n")
    cat(":::\n\n")
  } else if(cong$avg_attendance < 20) {
    cat("::: {.status-box .caution}\n")
    cat("**üìâ Low Attendance**\n\n")
    cat("With only ", round(cong$avg_attendance, 0), 
        " average attendees and ", round(cong$avg_members, 0), 
        " members, this congregation is operating at reduced capacity.\n", sep = "")
    cat(":::\n\n")
  } else {
    cat("::: {.status-box .success}\n")
    cat("**‚úì Active Congregation**\n\n")
    cat(round(cong$avg_attendance, 0), 
        " average attendees with ", round(cong$avg_members, 0), " members.\n", sep = "")
    cat(":::\n\n")
  }
  
  cat("#### Financial Trend {.section-header}\n\n")
  
  if(!is.na(cong$pct_change_pledge)) {
    if(cong$pct_change_pledge < -20) {
      cat("::: {.status-box .warning}\n")
      cat("**üí∞ Significant Decline**\n\n")
      cat("Plate & pledge has decreased by **", 
          abs(round(cong$pct_change_pledge, 1)), "%** over the past decade.\n", sep = "")
      cat(":::\n\n")
    } else if(cong$pct_change_pledge < 0) {
      cat("::: {.status-box .caution}\n")
      cat("**üí∞ Modest Decline**\n\n")
      cat("Plate & pledge has decreased by **", 
          abs(round(cong$pct_change_pledge, 1)), "%** over the past decade.\n", sep = "")
      cat(":::\n\n")
    } else {
      cat("::: {.status-box .success}\n")
      cat("**üí∞ Positive Trend**\n\n")
      cat("Plate & pledge has increased by **", 
          round(cong$pct_change_pledge, 1), "%** over the past decade.\n", sep = "")
      cat(":::\n\n")
    }
  } else {
    cat("*Financial data not available.*\n\n")
  }
  
  # ---- TAB 3: Property Details ----
  cat("### Property Details\n\n")
  
  cat("| Metric | Value |\n")
  cat("|--------|-------|\n")
  cat("| Total Parcels | ", cong$n_parcels, " |\n", sep = "")
  cat("| Total Acreage | ", round(cong$total_acres, 2), " acres |\n", sep = "")
  cat("| Total Assessed Value | ", scales::dollar(cong$total_value, accuracy = 1), " |\n", sep = "")
  cat("| Mean Dev Score | ", round(cong$mean_dev_score, 1), " |\n", sep = "")
  if(cong$n_parcels > 1) {
    cat("| Max Dev Score | ", round(cong$max_dev_score, 1), " |\n", sep = "")
  }
  cat("| Walkability Score | ", ifelse(is.na(cong$walkability_score), "N/A", paste0(round(cong$walkability_score, 1), "/20")), " |\n", sep = "")
  cat("| Location | ", cong$site_city, ", ", cong$site_county, " |\n\n", sep = "")
  
  cat("**Parcel ID(s):** `", cong$parcel_ids, "`\n\n", sep = "")
  
  if(cong$n_parcels > 1) {
    cat("**Addresses:**\n\n")
    addresses <- strsplit(cong$addresses, "; ")[[1]]
    for(addr in addresses) {
      cat("- ", addr, "\n", sep = "")
    }
    cat("\n")
  }
  
  # ---- TAB 4: VEREP Action ----
  cat("### VEREP Action\n\n")
  
  # Determine engagement rationale
  engagement_rationale <- case_when(
    !is.na(cong$avg_attendance) && cong$avg_attendance == 0 ~ "Zero attendance suggests potential for congregational transition",
    !is.na(cong$avg_attendance) && cong$avg_attendance < 20 ~ "Low attendance congregation may be open to development partnership",
    cong$n_parcels > 1 ~ "Multi-parcel portfolio enables phased or consolidated development strategy",
    cong$total_acres >= 5 ~ "Large combined acreage enables significant development opportunity",
    !is.na(cong$walkability_score) && cong$walkability_score >= 15 ~ "High walkability supports transit-oriented development",
    TRUE ~ "High development potential based on site characteristics"
  )
  
  recommended_action <- case_when(
    !is.na(cong$avg_attendance) && cong$avg_attendance == 0 ~ "Assess congregational status and readiness for transition",
    cong$n_parcels > 1 ~ "Map all parcels to identify consolidation or phased development approach",
    TRUE ~ "Engage leadership on development partnership options"
  )
  
  cat("::: {.info-box}\n")
  cat("**üéØ Why Engage:** ", engagement_rationale, "\n\n", sep = "")
  cat("**‚úÖ Recommended Action:** ", recommended_action, "\n")
  cat(":::\n\n")
  
  cat("#### Suggested Next Steps\n\n")
  
  cat("::: {.steps-box}\n")
  if(cong$avg_attendance == 0 || is.na(cong$avg_attendance)) {
    cat("1. Contact diocesan staff to verify congregation's current status\n")
    cat("2. Schedule site visit to assess property condition\n")
    cat("3. If inactive, begin transition planning process\n")
    cat("4. Engage remaining members on legacy preservation options\n")
  } else if(cong$n_parcels > 1) {
    cat("1. Map all parcels to identify consolidation opportunities\n")
    cat("2. Assess which parcel(s) best serve ongoing worship needs\n")
    cat("3. Evaluate surplus parcels for development potential\n")
    cat("4. Present phased transition plan to vestry\n")
  } else {
    cat("1. Schedule introductory meeting with vestry leadership\n")
    cat("2. Present development partnership models and case studies\n")
    cat("3. Conduct preliminary site feasibility assessment\n")
    cat("4. Develop customized proposal based on congregation's goals\n")
  }
  cat(":::\n\n")
  
  cat("#### Key Contacts to Identify\n\n")
  cat("- [ ] Vestry leadership / Senior Warden\n")
  cat("- [ ] Diocesan regional representative\n")
  cat("- [ ] Property committee chair (if applicable)\n\n")
  
  # End tabset
  cat(":::\n\n")
  
  cat("---\n\n")
}

# Generate all congregation profiles
for(i in 1:nrow(high_potential_congregations)) {
  create_congregation_profile(i)
}
```

## Interactive ADU Placement Tool

For an interactive experience, [**launch the ADU Placement Dashboard**](https://mted.shinyapps.io/shiny-app/?tab=adu)

<iframe src="https://mted.shinyapps.io/shiny-app/?tab=adu" width="100%" height="600px" frameborder="0">

</iframe>
