---
title: "VEREP Property Development Analysis"
subtitle: "Strategic Assessment of Development Opportunities"
author: "HDAdvisors"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    theme: cosmo
    code-fold: true
    embed-resources: true
server: shiny
---

```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)
library(scales)
library(DT)
library(shiny)
library(kableExtra)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)
```

```{r load-and-process-data, include=FALSE}
# Load data
parcels_raw <- read_csv("data/verep040725.csv")
congregations_raw <- read_csv("data/congregation.csv")

# Process congregations
congregations <- congregations_raw %>%
  mutate(
    pct_change_attendance = ((f2023_sunday_attendance - f2014_sunday_attendance) / 
                              f2014_sunday_attendance) * 100,
    pct_change_members = ((f2023_members_this_year - f2014_members_this_year) / 
                           f2014_members_this_year) * 100,
    pct_change_pledge = ((f2023_plate_and_pledge - f2014_plate_and_pledge) / 
                          f2014_plate_and_pledge) * 100,
    avg_attendance = attendance_avg,
    avg_members = member_avg,
    avg_pledge = platepledge_avg,
    financial_need = case_when(
      pct_change_pledge < -20 ~ 3,
      pct_change_pledge < 0 ~ 2,
      pct_change_pledge < 10 ~ 1,
      TRUE ~ 0
    ),
    size_category = case_when(
      avg_attendance < 25 ~ "Very Small",
      avg_attendance < 50 ~ "Small",
      avg_attendance < 100 ~ "Medium",
      avg_attendance < 200 ~ "Large",
      TRUE ~ "Very Large"
    )
  ) %>%
  mutate(across(starts_with("pct_change"), ~replace_na(., 0)),
         across(starts_with("avg_"), ~replace_na(., 0)))

# Process parcels
df <- parcels_raw %>%
  mutate(
    area_acres = case_when(
      !is.na(rgisacre) ~ rgisacre,
      !is.na(rgissqft) ~ rgissqft / 43560,
      !is.na(deed_acres) ~ deed_acres,
      TRUE ~ NA_real_
    ),
    use_church = church == 1,
    use_cemetery = cemetery == 1,
    use_school = school == 1,
    use_parking = parking == 1,
    use_open_space = open_space == 1,
    use_residence = residence == 1,
    flood_zone = case_when(
      is.na(fema_fz) | fema_fz == "X" ~ "None",
      TRUE ~ fema_fz
    ),
    wetlands_pct = replace_na(wet_perc, 0),
    has_easement = !is.na(easement) & easement != "",
    in_historic_district = !is.na(hist_dist) & hist_dist != "",
    walkability_score = replace_na(walk_idx, 0),
    transit_access_score = case_when(
      trans_acc >= 3 ~ 100,
      trans_acc == 2 ~ 60,
      trans_acc == 1 ~ 30,
      TRUE ~ 0
    ),
    zoning_favorable = case_when(
      str_detect(zon_desc, regex("mixed|commercial|residential", ignore_case = TRUE)) ~ TRUE,
      TRUE ~ FALSE
    ),
    median_income = medinc,
    poverty_rate = pov_prc,
    qualified_census_tract = !is.na(qct) & qct != 0,
    year_built = case_when(
      yr_blt_num > 1700 & yr_blt_num < 2025 ~ yr_blt_num,
      TRUE ~ NA_real_
    ),
    assessed_value = par_val,
    site_address = sadd,
    site_city = scity,
    site_county = scounty
  ) %>%
  filter(!is.na(area_acres), area_acres > 0.1, !is.na(lat) & !is.na(lon))

# Join data
df_joined <- df %>%
  left_join(
    congregations %>% select(name, short_name, pct_change_attendance, pct_change_members, 
                            pct_change_pledge, avg_attendance, avg_members, avg_pledge,
                            financial_need, size_category),
    by = c("congr_name" = "short_name")
  ) %>%
  mutate(
    has_congregation = !is.na(name),
    pct_change_pledge = case_when(
      !has_congregation & use_church ~ 0,
      TRUE ~ pct_change_pledge
    ),
    financial_need = case_when(
      !has_congregation & use_church ~ 1,
      TRUE ~ financial_need
    )
  )

# Calculate scores
scored_parcels <- df_joined %>%
  mutate(
    size_score = case_when(
      area_acres < 0.25 ~ 20, area_acres < 0.5 ~ 50, area_acres < 1 ~ 70,
      area_acres < 2 ~ 90, area_acres < 5 ~ 100, area_acres < 10 ~ 85,
      TRUE ~ 70
    ),
    use_score = case_when(
      use_parking ~ 95, use_open_space ~ 90, use_cemetery ~ 5,
      use_church & !use_parking & !use_open_space ~ 30,
      use_residence ~ 40, use_school ~ 35, TRUE ~ 60
    ),
    location_score = (
      (walkability_score / max(walkability_score, na.rm = TRUE) * 60) +
      (transit_access_score * 0.4)
    ),
    location_score = pmin(100, pmax(0, location_score)),
    financial_score = case_when(
      is.na(financial_need) ~ 30, financial_need == 3 ~ 100,
      financial_need == 2 ~ 70, financial_need == 1 ~ 40, TRUE ~ 20
    ),
    market_score = case_when(
      is.na(median_income) ~ 50, median_income > 100000 ~ 90,
      median_income > 75000 ~ 75, median_income > 50000 ~ 60, TRUE ~ 40
    ),
    market_score = if_else(qualified_census_tract, market_score + 15, market_score),
    market_score = pmin(100, market_score),
    zoning_score = if_else(zoning_favorable, 80, 40),
    constraint_penalty = case_when(
      flood_zone != "None" ~ -40, wetlands_pct > 25 ~ -35,
      has_easement ~ -30, in_historic_district ~ -25,
      wetlands_pct > 10 ~ -20, TRUE ~ 0
    ),
    development_score = (
      (size_score * 0.20) + (use_score * 0.25) + (location_score * 0.20) +
      (financial_score * 0.15) + (market_score * 0.10) + (zoning_score * 0.10)
    ) + constraint_penalty,
    development_score = pmin(100, pmax(0, development_score)),
    development_tier = case_when(
      development_score >= 75 ~ "Tier 1: High Priority",
      development_score >= 60 ~ "Tier 2: Strong Potential",
      development_score >= 45 ~ "Tier 3: Moderate Potential",
      development_score >= 30 ~ "Tier 4: Limited Potential",
      TRUE ~ "Tier 5: Not Recommended"
    )
  )

# Get top 10
top_10 <- scored_parcels %>%
  arrange(desc(development_score)) %>%
  slice_head(n = 10) %>%
  mutate(rank = row_number())
```

# Executive Summary {.unnumbered}

::: {.callout-important}
## Key Findings

This analysis evaluated **`r nrow(scored_parcels)` properties** across the diocese to identify optimal development opportunities. Using a comprehensive scoring methodology, we identified **10 high-priority properties** representing **`r round(sum(top_10$area_acres), 1)` total acres** with significant development potential.

**Top Insights:**

- **`r sum(scored_parcels$development_score >= 60)` properties** score in Tier 1-2 (strong development potential)
- **Primary opportunities:** Underutilized parking lots and open space
- **Average parcel size:** `r round(mean(df$area_acres, na.rm = TRUE), 2)` acres
- **Congregations with declining pledges:** `r sum(top_10$financial_need >= 2, na.rm = TRUE)` properties show high financial need
:::

::: {.callout-tip}
## ðŸ”— Full Interactive Dashboard

For advanced exploration and analysis, launch the **[Full Interactive Dashboard](http://localhost:3838/)** which includes:

- Real-time filtering and property comparison
- Detailed property profiles with score breakdowns
- Export functionality (PowerPoint, Excel)
- Advanced visualization tools

*Run the dashboard by executing `shiny::runApp("app.R")` in your R console*
:::

---

# Interactive Property Explorer

Use the controls below to explore properties based on your criteria. The map and table update in real-time as you adjust the filters.

```{r}
#| panel: sidebar

sliderInput("score_filter", 
            "Development Score Range:", 
            min = 0, max = 100, 
            value = c(60, 100),
            step = 5)

checkboxGroupInput("tier_filter",
                  "Development Tiers:",
                  choices = unique(scored_parcels$development_tier),
                  selected = c("Tier 1: High Priority", "Tier 2: Strong Potential"))

sliderInput("size_filter",
            "Property Size (acres):",
            min = 0,
            max = ceiling(max(scored_parcels$area_acres, na.rm = TRUE)),
            value = c(0, 10),
            step = 0.5)

numericInput("top_n",
            "Show Top N Properties:",
            value = 10,
            min = 5,
            max = 50,
            step = 5)
```

```{r}
#| panel: fill

tabsetPanel(
  tabPanel("Map View", 
           leafletOutput("property_map", height = 500)),
  tabPanel("Table View", 
           DTOutput("property_table")),
  tabPanel("Score Distribution",
           plotOutput("score_dist", height = 400))
)
```

```{r}
#| context: server

# Reactive filtered data
filtered_properties <- reactive({
  scored_parcels %>%
    filter(
      development_score >= input$score_filter[1],
      development_score <= input$score_filter[2],
      development_tier %in% input$tier_filter,
      area_acres >= input$size_filter[1],
      area_acres <= input$size_filter[2]
    )
})

# Interactive map
output$property_map <- renderLeaflet({
  data <- filtered_properties()
  
  pal <- colorNumeric(palette = "YlOrRd", domain = c(0, 100))
  
  leaflet(data) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addCircleMarkers(
      lng = ~lon, lat = ~lat,
      radius = ~sqrt(area_acres) * 3,
      fillColor = ~pal(development_score),
      fillOpacity = 0.7,
      color = "white",
      weight = 1,
      popup = ~paste0(
        "<b>", site_address, "</b><br>",
        site_city, ", ", site_county, "<br>",
        "<hr>",
        "<b>Score:</b> ", round(development_score, 1), "/100<br>",
        "<b>Size:</b> ", round(area_acres, 2), " acres<br>",
        "<b>Tier:</b> ", development_tier,
        if_else(!is.na(name), paste0("<br><b>Congregation:</b> ", name), "")
      )
    ) %>%
    addLegend(
      position = "bottomright",
      pal = pal,
      values = c(0, 100),
      title = "Development<br>Score"
    )
})

# Property table
output$property_table <- renderDT({
  filtered_properties() %>%
    arrange(desc(development_score)) %>%
    slice_head(n = input$top_n) %>%
    select(site_address, site_city, area_acres, development_score, 
           development_tier, use_parking, use_open_space) %>%
    mutate(
      use_parking = if_else(use_parking, "âœ“", ""),
      use_open_space = if_else(use_open_space, "âœ“", "")
    ) %>%
    datatable(
      options = list(pageLength = 10, scrollX = TRUE),
      rownames = FALSE,
      colnames = c("Address", "City", "Acres", "Score", "Tier", 
                   "Parking", "Open Space")
    ) %>%
    formatRound(c("area_acres", "development_score"), 1) %>%
    formatStyle("development_score",
                background = styleColorBar(c(0, 100), "#3c8dbc"),
                backgroundSize = "98% 88%",
                backgroundRepeat = "no-repeat",
                backgroundPosition = "center")
})

# Score distribution chart
output$score_dist <- renderPlot({
  data <- filtered_properties()
  
  ggplot(data, aes(x = development_score)) +
    geom_histogram(bins = 20, fill = "#3c8dbc", alpha = 0.7, color = "white") +
    geom_vline(xintercept = median(data$development_score), 
               linetype = "dashed", color = "red", size = 1) +
    annotate("text", 
             x = median(data$development_score), 
             y = Inf, 
             label = paste("Median:", round(median(data$development_score), 1)),
             vjust = 2, hjust = -0.1, color = "red") +
    labs(
      title = paste("Development Score Distribution (", nrow(data), "properties)"),
      x = "Development Score",
      y = "Number of Properties"
    ) +
    theme_minimal(base_size = 14)
})
```

**Properties Currently Displayed:** `r textOutput("property_count", inline = TRUE)`

```{r}
#| context: server
output$property_count <- renderText({
  nrow(filtered_properties())
})
```

---

# Key Findings

## Significant Underutilized Assets

**`r sum(scored_parcels$development_score >= 60)` properties** score in Tier 1-2, representing substantial untapped value across the diocese. Primary opportunities exist in:

- **Parking lots** (highest development scores): Structured parking with mixed-use above can maximize land value while maintaining or increasing parking capacity
- **Open space parcels**: Well-located vacant land ideal for ground lease arrangements that provide long-term revenue without property sale
- **Properties with declining congregations**: Sites where strategic development can provide financial stability through ground lease income or shared facility arrangements

### Geographic Distribution

Development opportunities are distributed across Virginia, with notable concentrations in:

- **Urban/suburban areas** with strong walkability scores (>50) and transit access
- **Markets with favorable demographics** including LIHTC-eligible census tracts
- **Transit-accessible locations** supporting reduced parking requirements and higher density development

### Financial Sustainability Imperative

**`r sum(top_10$financial_need >= 2, na.rm = TRUE)` of the top 10 properties** are associated with congregations showing significant financial decline, with pledge revenue down 20% or more over the past decade. Strategic development can provide:

- **Long-term ground lease revenue** - Annual income from 50-99 year ground leases
- **Capital for building improvements** - Upfront payments or phased development fees
- **Sustainable financial model** - Diversified revenue supporting congregation vitality

---

# Methodology & Scoring Framework

## Data Sources

### VEREP Parcel Dataset

This analysis utilizes the Virginia Episcopal Real Estate Portfolio (VEREP) parcel dataset, compiled by CGS Consultants, including:

- **`r nrow(parcels_raw)` parcels** across Virginia
- Comprehensive property characteristics (size, use, zoning)
- Environmental constraints (floodplains, wetlands, easements)
- Location metrics (walkability index, transit access scores)
- Market indicators (median income, poverty rates, demographics)

### Congregation Statistics (2014-2023)

Financial and membership data provides context on congregation health:

- Sunday attendance trends over 10-year period
- Membership changes and demographic shifts
- Plate & pledge revenue tracking
- Long-term trend analysis for financial sustainability assessment

## Development Potential Scoring

Our methodology evaluates six key dimensions, each scored 0-100 and weighted by importance:

```{r scoring-framework-chart}
scoring_components <- tibble(
  Component = c("Current Use", "Property Size", "Location Quality", 
                "Financial Need", "Market Potential", "Zoning"),
  Weight = c(25, 20, 20, 15, 10, 10),
  Description = c(
    "Parking lots (95) and open space (90) score highest",
    "Optimal size 0.5-5 acres scores 100 points",
    "Based on walkability index and transit access",
    "Congregation financial trends indicate need",
    "Area income levels and LIHTC eligibility",
    "Development-friendly zoning gets 80 points"
  )
)

ggplot(scoring_components, aes(x = reorder(Component, Weight), y = Weight)) +
  geom_col(fill = "#3c8dbc", alpha = 0.8) +
  geom_text(aes(label = paste0(Weight, "%")), 
            hjust = -0.2, size = 5, color = "#3c8dbc", fontface = "bold") +
  coord_flip() +
  scale_y_continuous(limits = c(0, 30)) +
  labs(
    title = "Development Score Components",
    subtitle = "Weighted contribution to final score",
    x = "",
    y = "Weight (%)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#3c8dbc"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )
```

### Constraint Penalties

After calculating the weighted score, properties receive deductions for development constraints:

- **Flood zones (FEMA designated):** -40 points
- **Significant wetlands (>25% of parcel):** -35 points
- **Recorded easements:** -30 points
- **Historic district designation:** -25 points
- **Moderate wetlands (>10% of parcel):** -20 points

Final scores are capped between 0-100.

## Development Tiers

Properties are classified into five tiers based on composite scores:

| Tier | Score Range | Classification | Description |
|------|-------------|----------------|-------------|
| **Tier 1** | 75-100 | High Priority | Immediate development candidates with minimal barriers |
| **Tier 2** | 60-74 | Strong Potential | Near-term opportunities requiring standard due diligence |
| **Tier 3** | 45-59 | Moderate Potential | Requires creative solutions or constraint mitigation |
| **Tier 4** | 30-44 | Limited Potential | Significant barriers exist, long-term consideration only |
| **Tier 5** | <30 | Not Recommended | Unsuitable for development due to multiple constraints |

---

# Analysis Results

## Development Opportunity Landscape

```{r tier-distribution}
tier_data <- scored_parcels %>%
  count(development_tier) %>%
  mutate(
    pct = n / sum(n) * 100,
    tier_order = case_when(
      str_detect(development_tier, "Tier 1") ~ 1,
      str_detect(development_tier, "Tier 2") ~ 2,
      str_detect(development_tier, "Tier 3") ~ 3,
      str_detect(development_tier, "Tier 4") ~ 4,
      TRUE ~ 5
    ),
    color = case_when(
      tier_order == 1 ~ "#3c8dbc",
      tier_order == 2 ~ "#00a65a",
      tier_order == 3 ~ "#f39c12",
      tier_order == 4 ~ "#dd4b39",
      TRUE ~ "#999999"
    )
  ) %>%
  arrange(tier_order)

ggplot(tier_data, aes(x = reorder(development_tier, -tier_order), y = n, fill = color)) +
  geom_col() +
  geom_text(aes(label = paste0(n, "\n(", round(pct, 1), "%)")), 
            vjust = 1.5, color = "white", size = 5, fontface = "bold") +
  scale_fill_identity() +
  labs(
    title = "Distribution of Properties by Development Tier",
    subtitle = paste0("Total Properties Analyzed: ", sum(tier_data$n)),
    x = "",
    y = "Number of Properties"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#3c8dbc"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    panel.grid.major.x = element_blank()
  )
```

The distribution shows a healthy pipeline of development opportunities, with **`r sum(tier_data$n[tier_data$tier_order <= 2])`** properties in the top two tiers representing **`r round(sum(tier_data$pct[tier_data$tier_order <= 2]), 1)`%** of the total portfolio.

## Top 10 Development Priorities

```{r top-10-table}
top_10 %>%
  select(rank, site_address, site_city, area_acres, development_score, development_tier) %>%
  kable(
    col.names = c("Rank", "Property Address", "City", "Acres", "Score", "Tier"),
    digits = 1,
    align = c("c", "l", "l", "r", "r", "l")
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  kableExtra::column_spec(1, bold = TRUE, color = "white", background = "#3c8dbc") %>%
  kableExtra::column_spec(5, bold = TRUE, color = "#3c8dbc")
```

---

# Portfolio Statistics

## Property Use Distribution

```{r use-type-chart}
use_stats <- scored_parcels %>%
  mutate(
    primary_use = case_when(
      use_cemetery ~ "Cemetery",
      use_school ~ "School",
      use_parking ~ "Parking",
      use_open_space ~ "Open Space",
      use_residence ~ "Residential",
      use_church ~ "Church/Worship",
      TRUE ~ "Other/Mixed"
    )
  ) %>%
  count(primary_use) %>%
  arrange(desc(n))

ggplot(use_stats, aes(x = reorder(primary_use, n), y = n)) +
  geom_col(fill = "#3c8dbc", alpha = 0.8) +
  geom_text(aes(label = n), hjust = -0.2, color = "#3c8dbc", fontface = "bold", size = 5) +
  coord_flip() +
  labs(
    title = "Property Distribution by Primary Use",
    x = "",
    y = "Number of Parcels"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#3c8dbc"),
    panel.grid.major.y = element_blank()
  )
```

## Congregation Vitality Metrics

```{r congregation-stats}
cong_stats <- df_joined %>%
  filter(has_congregation) %>%
  summarise(
    parcels_with_cong_data = n(),
    parcels_under_30_attendance = sum(avg_attendance < 30, na.rm = TRUE),
    pct_under_30 = (parcels_under_30_attendance / n()) * 100,
    avg_attendance_all = mean(avg_attendance, na.rm = TRUE),
    avg_pledge_all = mean(avg_pledge, na.rm = TRUE),
    declining_pledges = sum(pct_change_pledge < 0, na.rm = TRUE)
  )
```

**Key Congregation Metrics:**

- **Parcels with congregation data:** `r cong_stats$parcels_with_cong_data`
- **Parcels with <30 Sunday attendance:** `r cong_stats$parcels_under_30_attendance` (`r round(cong_stats$pct_under_30, 1)`% of total diocese)
- **Average Sunday attendance:** `r round(cong_stats$avg_attendance_all, 0)` people
- **Average annual pledge:** $`r scales::comma(cong_stats$avg_pledge_all, accuracy = 1)`
- **Congregations with declining pledges:** `r cong_stats$declining_pledges`

---

# Conclusion

## Strategic Opportunity Summary

The diocese portfolio contains **substantial untapped development value**, with `r sum(scored_parcels$development_score >= 60)` properties showing strong potential for strategic partnerships. The top 10 properties alone represent over `r round(sum(top_10$area_acres), 1)` acres of developable land in favorable locations, with `r sum(top_10$financial_need >= 2, na.rm = TRUE)` sites supporting congregations facing financial sustainability challenges.

### Strategic Development Can Deliver:

âœ“ **Long-term revenue streams** supporting congregational vitality through ground lease arrangements  
âœ“ **Affordable housing creation** aligned with diocesan mission and values  
âœ“ **Preservation of worship space** while maximizing underutilized land value  
âœ“ **Capital for improvements** addressing deferred maintenance and facility needs  

## Next Steps

::: {.callout-tip}
## Recommended Actions

1. **Commission feasibility studies** on top 3-5 properties to validate development assumptions
2. **Engage developer partners** through RFP/RFQ process for pilot project execution
3. **Launch full dashboard** for ongoing portfolio monitoring and stakeholder engagement
4. **Establish governance framework** for evaluating and approving development partnerships
:::

---

## Launch Full Dashboard

For comprehensive analysis capabilities, advanced filtering, and export functionality:

```{r}
#| panel: center

actionButton("launch_dashboard", 
             "ðŸš€ Launch Full Interactive Dashboard",
             class = "btn-primary btn-lg",
             onclick = "window.open('http://localhost:3838/', '_blank')")
```

<br>

::: {.callout-note}
**Note:** To run the full dashboard, execute `shiny::runApp("app.R")` in your R console from the VEREP folder.
:::

---

## Appendices

::: {.callout-note collapse="true"}
## Technical Methodology Details

**Data Quality Filters Applied:**

- Minimum parcel size: 0.1 acres
- Required valid latitude/longitude coordinates
- Valid building years: 1700-2025
- Excluded parcels with insufficient data quality

**Congregation-Parcel Matching:**

Properties were matched to congregation data using the `congr_name` field. Properties without matches received neutral financial scores (30 points) to avoid penalizing properties without available congregation data.

**Missing Data Handling:**

- Missing walkability scores: Defaulted to 0
- Missing income data: Received median market scores (50)
- Properties without area or coordinates: Excluded from analysis
:::

::: {.callout-note collapse="true"}
## Data Sources & References

**VEREP Parcel Dataset:** Compiled by CGS Consultants  
**Congregation Statistics:** Virginia Episcopal Diocese (2014-2023)  
**Analysis Date:** `r Sys.Date()`  
**Analyst:** HDAdvisors
:::

---

*Report generated with Quarto and R. Interactive components powered by Shiny.*