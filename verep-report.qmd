---
title: "VEREP Property Development Analysis"
subtitle: "Strategic Assessment of Development Opportunities"
author: "HDAdvisors"
date: today
css: hda-styles.css
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    code-summary: "Show code"
    embed-resources: true
    theme: cosmo
    number-sections: true
execute:
  warning: false
  message: false
  echo: false
---
```{css, echo=FALSE}

.stat-box {
  background: linear-gradient(135deg, #445ca9 0%, #8baeaa 100%);
  color: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  margin: 10px;
}

.stat-number {
  font-size: 2.5em;
  font-weight: bold;
  font-family: 'Roboto Slab', serif;
}

.stat-label {
  font-size: 0.9em;
  text-transform: uppercase;
  letter-spacing: 1px;
}
```

```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)
library(leaflet.extras)
library(sf)
library(scales)
library(kableExtra)
library(shiny)
library(tidygeocoder)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  fig.width = 10,
  fig.height = 6
)

# ADU design library
adu_designs <- tibble(
  name = c("Modal 01", "Dwight", "Compact Studio", "Large 2BR"),
  sqft = c(432, 594, 350, 850),
  width_ft = c(20, 25, 15, 30),
  length_ft = c(22, 24, 23, 28),
  bedrooms = c(1, 1, 0, 2),
  color = c("#445ca9", "#8baeaa", "#e85d75", "#f39c12")
)

# Function to convert feet to approximate degrees
ft_to_degrees <- function(feet, lat) {
  ft_to_deg_lat <- 1 / 364000
  ft_to_deg_lng <- 1 / (288200 * cos(lat * pi / 180))
  list(lat = feet * ft_to_deg_lat, lng = feet * ft_to_deg_lng)
}

# Function to create ADU polygon at a point
create_adu_polygon <- function(lng, lat, width_ft, length_ft, rotation = 0) {
  deg <- ft_to_degrees(1, lat)
  
  half_width <- (width_ft * deg$lng) / 2
  half_length <- (length_ft * deg$lat) / 2
  
  # Create rectangle
  coords <- matrix(c(
    lng - half_width, lat - half_length,
    lng + half_width, lat - half_length,
    lng + half_width, lat + half_length,
    lng - half_width, lat + half_length,
    lng - half_width, lat - half_length
  ), ncol = 2, byrow = TRUE)
  
  # Apply rotation if needed (future enhancement)
  st_polygon(list(coords)) %>%
    st_sfc(crs = 4326)
}

```

```{r load-processed-data, include=FALSE}
# Load the pre-processed outputs from GIS Report.R
property_profile <- read_csv("data/output/verep_full_analysis.csv", show_col_types = FALSE)
attendance_context <- read_csv("data/output/verep_attendance_summary.csv", show_col_types = FALSE)
opportunity_matrix <- read_csv("data/output/verep_opportunity_matrix.csv", show_col_types = FALSE)
leadership_report <- read_csv("data/output/verep_top_opportunities.csv", show_col_types = FALSE)
data_followup <- read_csv("data/output/verep_data_needed.csv", show_col_types = FALSE)

# Create enhanced version with aliases and calculated fields
property_profile <- property_profile |>
  mutate(
    area_acres = rgisacre,
    development_score = case_when(
      development_potential == "High Potential" ~ 85,
      development_potential == "Moderate Potential" ~ 70,
      development_potential == "Low Potential - Constraints" ~ 40,
      development_potential == "Insufficient Data" ~ 30,
      TRUE ~ 20
    ),
    development_tier = development_potential,
    assessed_value = lan_val,
    use_church = !is.na(church) & church == 1,
    use_parking = !is.na(parking) & parking == 1,
    use_open_space = !is.na(open_space) & open_space == 1,
    use_cemetery = !is.na(cemetery) & cemetery == 1,
    use_school = !is.na(school) & school == 1,
    use_residence = !is.na(residence) & residence == 1,
    avg_attendance = attendance_2023,
    avg_pledge = plate_pledge_2023,
    bldgcount = 1,
    year_built = 1950,
    has_congregation = !is.na(congregation_name)
  )

# Get top 10 for property profiles section
top_10 <- property_profile |>
  filter(development_potential %in% c("High Potential", "Moderate Potential")) |>
  arrange(desc(lan_val)) |>
  slice_head(n = 10) |>
  mutate(
    rank = row_number(),
    site_address = sadd,
    site_city = scity,
    site_county = scounty,
    name = congregation_name,
    walkability_score = walk_idx,
    financial_need = case_when(
      !is.na(pct_change_pledge) & pct_change_pledge < -20 ~ 3,
      !is.na(pct_change_pledge) & pct_change_pledge < 0 ~ 2,
      !is.na(pct_change_attendance) & pct_change_attendance < -20 ~ 2,
      data_completeness < 4 ~ 1,
      TRUE ~ 1
    )
  )

if (!"lon" %in% names(top_10) || !"lat" %in% names(top_10)) {
  top_10 <- top_10 %>%
    mutate(full_address = paste(site_address, site_city, site_county, "VA")) %>%
    geocode(address = full_address, method = "osm", quiet = TRUE) %>%
    rename(lon = long, lat = lat)  # Keep as lon/lat for consistency
}
```

# Executive Summary {.unnumbered}

This analysis examines properties with fewer than 30 Sunday attendees, focusing on development potential through five key metrics: land value, zoning/density, acreage, environmental limitations, and Qualified Census Tract (QCT) status.

```{r exec-summary-stats, echo=FALSE, results='asis'}
# Calculate all stats first
total_analyzed <- nrow(property_profile)
high_priority <- nrow(top_10)
total_acres <- round(sum(top_10$area_acres, na.rm = TRUE), 1)
tier_1_2_count <- sum(property_profile$development_score >= 60, na.rm = TRUE)
avg_parcel <- round(mean(property_profile$area_acres, na.rm = TRUE), 2)
financial_need_count <- sum(top_10$financial_need >= 2, na.rm = TRUE)

# Output the callout
cat("::: {.callout-important}\n")
cat("## Key Findings\n\n")
cat("This analysis evaluated **", total_analyzed, "** properties across the diocese to identify optimal development opportunities. We identified **", high_priority, " high-priority properties** representing **", total_acres, " total acres** with significant development potential.\n\n", sep = "")
cat("**Top Insights:**\n\n")
cat("- **", tier_1_2_count, "** properties score in Tier 1-2 (strong development potential)\n", sep = "")
cat("- **Primary opportunities:** Underutilized parking lots and open space\n")
cat("- **Average parcel size:** ", avg_parcel, " acres\n", sep = "")
cat("- **Congregations with declining pledges:** ", financial_need_count, " properties show high financial need\n", sep = "")
cat(":::\n\n")

# Stat boxes
cat('<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">\n')

cat('<div class="stat-box">\n')
cat('<div class="stat-number">', total_analyzed, '</div>\n', sep = "")
cat('<div class="stat-label">Properties Analyzed</div>\n')
cat('</div>\n\n')

cat('<div class="stat-box">\n')
cat('<div class="stat-number">', high_priority, '</div>\n', sep = "")
cat('<div class="stat-label">High Priority Sites</div>\n')
cat('</div>\n\n')

cat('<div class="stat-box">\n')
cat('<div class="stat-number">', total_acres, '</div>\n', sep = "")
cat('<div class="stat-label">Developable Acres</div>\n')
cat('</div>\n\n')

cat('<div class="stat-box">\n')
cat('<div class="stat-number">', financial_need_count, '</div>\n', sep = "")
cat('<div class="stat-label">Financial Need</div>\n')
cat('</div>\n\n')

cat('</div>\n')
```

------------------------------------------------------------------------

## At a Glance: Top 10 Properties

```{r top-10-summary-table}
top_10 |>
  select(rank, site_address, site_city, area_acres, development_score, development_tier) |>
  kable(
    col.names = c("Rank", "Property Address", "City", "Acres", "Score", "Tier"),
    digits = 1,
    align = c("c", "l", "l", "r", "r", "l")
  ) |>
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  ) |>
  column_spec(1, bold = TRUE, color = "white", background = "#445ca9") |>
  column_spec(5, bold = TRUE, color = "#445ca9") |>
  row_spec(1:3, background = "#f8f9fa")
```

------------------------------------------------------------------------

# Key Findings

```{r key-findings-stats, echo=FALSE}
tier_1_2 <- sum(property_profile$development_score >= 60, na.rm = TRUE)
financial_decline <- sum(top_10$financial_need >= 2, na.rm = TRUE)
```

## Significant Underutilized Assets

```{r output-findings, echo=FALSE, results='asis'}
cat("**", tier_1_2, " properties** score in Tier 1-2 (strong development potential), representing substantial untapped value across the diocese. Primary opportunities exist in:\n\n", sep = "")
```

-   **Parking lots** (highest development scores): Structured parking with mixed-use above
-   **Open space parcels**: Well-located vacant land ideal for ground lease arrangements
-   **Properties with declining congregations**: Sites where development can provide financial stability

## Geographic Distribution

Development opportunities are distributed across Virginia, with concentrations in:

-   Urban/suburban areas with strong walkability scores
-   Markets with favorable demographics and LIHTC eligibility
-   Transit-accessible locations supporting reduced parking requirements

## Financial Sustainability Imperative

```{r output-financial, echo=FALSE, results='asis'}
cat("**", financial_decline, " of the top 10 properties** are associated with congregations showing significant financial decline (pledge revenue down 20%+ over past decade). Strategic development can provide:\n\n", sep = "")
```

-   Long-term ground lease revenue
-   Capital for building improvements
-   Sustainable financial model for congregation vitality

------------------------------------------------------------------------

# Methodology & Data

## Background & Data Sources

### VEREP Parcel Dataset

This analysis utilizes the Virginia Episcopal Real Estate Portfolio (VEREP) parcel dataset, compiled by CGS Consultants. The dataset includes:

```{r verep-count, echo=FALSE, results='asis'}
cat("- **", nrow(property_profile), " parcels** across Virginia\n", sep = "")
```

-   Comprehensive property characteristics (size, use, zoning)
-   Environmental constraints (floodplains, wetlands, easements)
-   Location metrics (walkability, transit access)
-   Market indicators (median income, demographics)

### Congregation Statistics (2014-2023)

Financial and membership data provides context on congregation health:

-   Sunday attendance trends
-   Membership changes
-   Plate & pledge revenue
-   10-year trend analysis

::: callout-note
## Data Quality Note

Not all properties have associated congregation data. Properties without congregation information received neutral scores in the financial need category.
:::

------------------------------------------------------------------------

## Analytical Framework

### Development Potential Scoring

Our methodology evaluates six key dimensions:

```{r scoring-visual, fig.height=4}
scoring_components <- tibble(
  Component = c("Property Size", "Current Use", "Location Quality", 
                "Financial Need", "Market Potential", "Zoning"),
  Weight = c(20, 25, 20, 15, 10, 10),
  Description = c(
    "Optimal size for development (0.5-5 acres scores highest)",
    "Underutilized properties (parking lots, open space)",
    "Walkability and transit accessibility",
    "Congregation financial health trends",
    "Area income levels and LIHTC eligibility",
    "Development-friendly zoning classifications"
  )
)

ggplot(scoring_components, aes(x = reorder(Component, Weight), y = Weight)) +
  geom_col(fill = "#445ca9", alpha = 0.8) +
  geom_text(aes(label = paste0(Weight, "%")), hjust = -0.2, size = 5, 
            color = "#445ca9", fontface = "bold") +
  coord_flip() +
  scale_y_continuous(limits = c(0, 30)) +
  labs(
    title = "Development Score Components",
    subtitle = "Weighted contribution to final score",
    x = "",
    y = "Weight (%)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#445ca9"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )
```

**Constraint Penalties:** Properties receive deductions for flood zones (-40), significant wetlands (-35), easements (-30), and historic district designation (-25).

### Development Tiers

Properties are classified into five tiers based on composite scores:

-   **Tier 1 (75-100):** High Priority - Immediate development candidates
-   **Tier 2 (60-74):** Strong Potential - Near-term opportunities
-   **Tier 3 (45-59):** Moderate Potential - Requires creative solutions
-   **Tier 4 (30-44):** Limited Potential - Significant barriers exist
-   **Tier 5 (\<30):** Not Recommended - Unsuitable for development

------------------------------------------------------------------------

## Understanding the Development Criteria

### Why These Factors Matter

Our scoring methodology reflects decades of real estate development experience and incorporates both market realities and mission-aligned priorities. Each criterion was selected to balance financial viability with community impact, ensuring that recommended properties can support sustainable development while serving congregational needs.

#### Property Size: The Goldilocks Principle

**Optimal Range: 0.5-5 acres**

Property size significantly influences development feasibility, but bigger isn't always better. Properties under a quarter-acre typically lack the critical mass needed for financially viable developmentâ€”construction costs per unit rise sharply, and parking or open space requirements become impossible to meet. Conversely, parcels exceeding 10 acres often present unique challenges: they may require complex phasing, demand substantial upfront capital, or face community resistance to density.

The "sweet spot" of 0.5-5 acres aligns with typical mixed-use development projects. A half-acre can accommodate a modest 20-30 unit building with ground-floor retail or community space. Two to three acres enables more ambitious projectsâ€”perhaps 75-100 residential units, structured parking, and meaningful ground-floor activation. Properties in this range also match the investment thresholds of most community development corporations and mission-driven developers who are natural partners for faith-based institutions.

#### Current Use: Identifying Low-Hanging Fruit

**Highest Potential: Parking Lots and Open Space**

Not all church property serves its highest and best use. Surface parking lots represent prime redevelopment opportunitiesâ€”they're already cleared and graded, typically have minimal environmental constraints, and often sit underutilized six days per week. A parking lot that serves 200 congregants on Sunday morning but stands empty Monday through Saturday represents an enormous opportunity cost.

Open space scores similarly high, particularly when it's amenity-free lawn rather than programmed recreation or memorial gardens. These properties can be reimagined while potentially retaining some green space within new development.

Conversely, active church buildings score lower not because development is impossible, but because it's complex. Any project must navigate active programming, potential relocation needs, and the emotional attachment congregations feel toward sacred spaces. Cemeteries score lowestâ€”they're essentially undevelopable under most state laws and carry profound cultural sensitivities.

#### Location Quality: Following the Market

**Key Metrics: Walkability Score and Transit Access**

Real estate development fundamentally responds to location. A walkable, transit-rich site commands higher rents, attracts more diverse tenants, and often qualifies for density bonuses or reduced parking requirementsâ€”all factors that improve project economics.

Walkability scores measure proximity to everyday needs: grocery stores, schools, employment centers, healthcare. High walkability (15-20 on our scale) indicates a property can support car-light or car-free households, expanding the potential tenant base to include young professionals, seniors aging in place, and lower-income families for whom car ownership is cost-prohibitive.

Transit access amplifies these benefits. Properties within a quarter-mile of frequent bus service or half-mile of rail stations can often negotiate reduced parking requirements with municipalitiesâ€”a significant cost savings when structured parking runs \$25,000-\$40,000 per space to construct.

#### Financial Need: Aligning Development with Mission

**Priority: Congregations with Declining Resources**

This criterion explicitly centers mission over pure market return. Congregations experiencing sustained pledge declines often face a difficult reality: their historic buildings demand expensive maintenance, but shrinking budgets make upkeep increasingly burdensome. Many such congregations sit on valuable real estate that could, through thoughtful development, generate steady income streams while maintaining their worship and ministry.

A ground lease arrangement, for example, might provide a struggling congregation with \$50,000-\$150,000 annually in stable incomeâ€”enough to fund a part-time rector, maintain the building, and sustain core ministries. This approach transforms real estate from a drain on resources into a mission enabler.

Properties associated with growing congregations score lower not because they lack development potential, but because the urgency is less acute. These communities likely have more options and less immediate financial pressure.

#### Market Potential: Reading Economic Signals

**Indicator: Area Median Income and LIHTC Eligibility**

Development must respond to market demand. Properties in higher-income areas (median incomes above \$75,000) typically support market-rate housing, ground-floor retail, or mixed-use projects that can cross-subsidize affordable components. These projects attract conventional financing and a broader range of development partners.

Properties in Qualified Census Tracts (QCTs) gain additional scoring weight because they unlock Low-Income Housing Tax Credit (LIHTC) financingâ€”the nation's primary mechanism for affordable housing production. LIHTC projects in QCTs receive point advantages in competitive funding rounds, improving their feasibility. For mission-driven institutions committed to affordable housing, QCT properties offer a rare alignment of social impact and financial viability.

#### Zoning: Navigating Regulatory Reality

**Favorable: Mixed-Use, Commercial, and Residential Districts**

Zoning powerfully shapes what's buildable and how quickly projects move from concept to construction. Properties zoned for residential or mixed-use development typically offer by-right development opportunitiesâ€”projects that don't require lengthy rezoning processes, conditional use permits, or special exceptions.

Conversely, properties in restrictive single-family or conservation districts may require multi-year regulatory processes, neighborhood opposition, and uncertain outcomes. While such projects occasionally succeed, they demand patient capital and sophisticated development partners.

#### Environmental and Regulatory Constraints: Deal-Breakers vs. Speed-Bumps

**Critical: Flood Zones, Wetlands, Easements, Historic Districts**

These constraints receive substantial score penalties because they materially affect project feasibility and cost. Properties in 100-year floodplains face expensive flood insurance, elevated construction costs, and increasingly cautious lenders post-climate-change. Development in such areas may be technically possible but financially marginal.

Significant wetlands (\>25% of parcel) trigger federal and state permitting, potential mitigation requirements, and uncertainty about buildable area. Easementsâ€”particularly those held by third partiesâ€”can restrict development rights, limit building envelopes, or prevent property subdivision.

Historic district designation doesn't prohibit development but adds layers of design review, material requirements, and timeline uncertainty. Some historic commissions embrace creative contemporary additions; others mandate strict historicism that may conflict with modern construction economics.

------------------------------------------------------------------------

### Bringing It All Together

These six criteria, combined with constraint penalties, create a holistic picture of development potential. A property might score exceptionally well on size and location but face significant challenges from environmental constraints. Another might have modest physical attributes but represent an urgent opportunity to support a financially stressed congregation.

The weighted scoring system allows us to compare apples to orangesâ€”to evaluate whether a small, perfectly-located property in a historic district outweighs a larger, unrestricted site with less market demand. This methodology doesn't make decisions for stakeholders but rather creates a common language for discussing trade-offs and priorities.

Ultimately, successful church real estate development requires more than high scores. It demands patient capital, mission-aligned partners, engaged congregations, and creative design. But by systematically evaluating these criteria, we can identify the properties where stars alignâ€”where market demand, congregational need, and regulatory environment converge to create genuine opportunity.

------------------------------------------------------------------------

# Analysis Results

## Development Opportunity Landscape

```{r tier-distribution-visual}
tier_data <- property_profile |>
  count(development_potential) |>
  mutate(
    pct = n / sum(n) * 100,
    tier_order = case_when(
      development_potential == "High Potential" ~ 1,
      development_potential == "Moderate Potential" ~ 2,
      development_potential == "Low Potential - Constraints" ~ 3,
      development_potential == "Insufficient Data" ~ 4,
      TRUE ~ 5
    ),
    color = case_when(
      tier_order == 1 ~ "#445ca9",
      tier_order == 2 ~ "#8baeaa",
      tier_order == 3 ~ "#e9ab3f",
      tier_order == 4 ~ "#e76f52",
      TRUE ~ "#cccccc"
    )
  ) |>
  arrange(tier_order)

ggplot(tier_data, aes(x = reorder(development_potential, -tier_order), y = n, fill = color)) +
  geom_col() +
  geom_text(aes(label = paste0(n, "\n(", round(pct, 1), "%)")), 
            vjust = 1.5, color = "white", size = 4, fontface = "bold") +
  scale_fill_identity() +
  labs(
    title = "Distribution of Properties by Development Tier",
    subtitle = paste0("Total Properties Analyzed: ", sum(tier_data$n)),
    x = "",
    y = "Number of Properties"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, color = "#445ca9"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    panel.grid.major.x = element_blank()
  )
```

------------------------------------------------------------------------

## Geographic Distribution

```{r top-10-map-html}
pal <- colorNumeric(
  palette = "YlOrRd",
  domain = top_10$development_score
)

leaflet(top_10) |>
  addProviderTiles(providers$CartoDB.Positron) |>
  addCircleMarkers(
    lng = ~lon,
    lat = ~lat,
    radius = ~sqrt(area_acres) * 5,
    fillColor = ~pal(development_score),
    fillOpacity = 0.8,
    color = "white",
    weight = 2,
    popup = ~paste0(
      "<div style='font-family: Lato, sans-serif; min-width: 250px;'>",
      "<h4 style='color: #445ca9; margin-bottom: 10px;'>Rank #", rank, "</h4>",
      "<p style='margin: 5px 0;'><b>", site_address, "</b><br>",
      site_city, ", ", site_county, " County</p>",
      "<hr style='margin: 10px 0;'>",
      "<p style='margin: 5px 0;'><b>Development Score:</b> ", round(development_score, 1), "/100<br>",
      "<b>Size:</b> ", round(area_acres, 2), " acres<br>",
      "<b>Tier:</b> ", development_tier, "</p>",
      if_else(!is.na(name), 
              paste0("<hr style='margin: 10px 0;'><p style='margin: 5px 0;'><b>Congregation:</b> ", name, "</p>"), 
              ""),
      "</div>"
    ),
    label = ~paste0("#", rank, ": ", site_address)
  ) |>
  addLegend(
    position = "bottomright",
    pal = pal,
    values = ~development_score,
    title = "Development<br>Score",
    opacity = 1
  ) |>
  setView(lng = mean(top_10$lon, na.rm = TRUE), lat = mean(top_10$lat, na.rm = TRUE), zoom = 7)
```

------------------------------------------------------------------------

## Data Quality Issues

One of the issues identified by CGS's initial study was that a large number of congregations either had incomplete or inconsistent data; many congregations share properties or fail to appropriately report their permanent address. Their final output data, which was utilized for this development analysis, reflected this. While environmental constraints accounted for the majority of the missing data, many others contained incomplete property information. For a closer look, we separated and classified these attributes below. These properties can be more precisely assessed for development once they have greater data.

```{r data-quality-stats, echo=FALSE}
# Load the exported data from your R script
incomplete_properties <- read_csv("data/output/incomplete_properties.csv", show_col_types = FALSE)
unassigned_addresses <- read_csv("data/output/unassigned_addresses.csv", show_col_types = FALSE)
shared_addresses <- read_csv("data/output/shared_addresses.csv", show_col_types = FALSE)
problem_matrix <- read_csv("data/output/problem_matrix_comprehensive.csv", show_col_types = FALSE)

# Calculate summary stats
total_props <- nrow(property_profile)
incomplete_data <- nrow(incomplete_properties)
missing_addresses <- sum(unassigned_addresses$num_unassigned)

# Create summary table
summary_stats <- tibble(
  Metric = c("Total properties analyzed",
             "Properties with incomplete data",
             "Properties with missing/unassigned addresses"),
  Value = c(total_props,
            paste0(incomplete_data, " (", round(incomplete_data/total_props*100, 1), "%)"),
            missing_addresses)
)

# Display as formatted table
summary_stats |>
  kable(align = c("l", "r")) |>
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE,
                position = "left") |>
  column_spec(1, bold = TRUE, width = "20em") |>
  column_spec(2, width = "10em")

```

```{r no-coords-warning, echo=FALSE, results='asis'}
no_coords_count <- sum(unassigned_addresses$has_coords == 0)

if(no_coords_count > 0) {
  cat("::: {.callout-warning}\n")
  cat("## Properties Without Coordinates\n")
  cat("**", no_coords_count, "** properties have neither valid addresses nor coordinates. These will require manual lookup using county tax records or additional dioses review.\n", sep = "")
  cat(":::\n")
}
```

```{r other-issues, echo=FALSE}
# Calculate missing data breakdown
missing_breakdown <- incomplete_properties |>
  summarise(
    missing_land_value = sum(missing_land_value),
    missing_acreage = sum(missing_acreage),
    missing_wetland = sum(missing_wetland),
    missing_flood = sum(missing_flood),
    missing_qct = sum(missing_qct),
    missing_zoning = sum(missing_zoning)
  ) |>
  pivot_longer(everything(), names_to = "data_type", values_to = "count") |>
  mutate(
    data_type = str_remove(data_type, "missing_"),
    data_type = str_to_title(str_replace_all(data_type, "_", " "))
  ) |>
  arrange(desc(count))

# Calculate properties with address issues using simple $ notation
props_with_incomplete_addr <- incomplete_properties$pin[
  is.na(incomplete_properties$sadd) | 
  incomplete_properties$sadd == "" | 
  incomplete_properties$sadd == "INCOMPLETE"
]

address_issues <- nrow(shared_addresses) + nrow(unassigned_addresses) + 
  nrow(incomplete_properties |> filter(is.na(sadd) | sadd == ""))

# Add Property Information row
missing_breakdown <- missing_breakdown |>
  add_row(
    data_type = "Property Information",
    count = address_issues
  ) |>
  arrange(desc(count))
```

```{r missing-data-chart, echo=FALSE, fig.height=4}
ggplot(missing_breakdown, aes(x = reorder(data_type, count), y = count)) +
  geom_col(fill = "#e76f52", alpha = 0.8) +
  geom_text(aes(label = count), hjust = -0.2, size = 4) +
  coord_flip() +
  labs(
    title = "Missing Data by Category",
    x = "",
    y = "Number of Properties"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", color = "#445ca9"),
    panel.grid.major.y = element_blank()
  )
```

------------------------------------------------------------------------

### Missing and Unassigned Addresses

The following congregations comprise the 19 "properties" without proper street addresses, making them difficult to verify or inspect for development. 3 of these congregations (comprising 14 of the total 19) had coordinates, which allowed for reverse geocoding to identify the likely address or zip code.

```{r unassigned-table, echo=FALSE}
unassigned_addresses |>
  select(congregation_name, num_unassigned, cities, has_coords) |>
  mutate(has_coords = if_else(has_coords > 0, "Yes", "No")) |>
  kable(
    col.names = c("Congregation", "# Unassigned Properties", "Cities", "Has Coordinates"),
    digits = 0
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  row_spec(which(unassigned_addresses$has_coords == 0), background = "#f8d7da")
```

```{r}
library(tidygeocoder)

needs_geocoding <- unassigned_addresses |>
  filter(!is.na(sample_lat) & !is.na(sample_lon))

geocoded_results <- needs_geocoding |>
  reverse_geocode(
    lat = sample_lat,
    long = sample_lon,
    method = "arcgis",
    full_results = FALSE
  )

# Save the geocoded addresses
write_csv(geocoded_results, "data/output/geocoded_unassigned_addresses.csv")

geocoded_results |>
  select(congregation_name, num_unassigned, cities, address) |>
  kable(
    col.names = c("Congregation", "# Properties", "Cities", "Geocoded Address")
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover"))

```

------------------------------------------------------------------------

### Shared Addresses

These properties have different congregations sharing the same street address, indicating potential shared facilities, rental arrangements, or data quality issues.

```{r shared-summary, echo=FALSE}
# Create summary from shared_addresses
shared_summary <- shared_addresses |>
  group_by(sadd, scity) |>
  summarise(
    num_congregations = n_distinct(congregation_name),
    congregations = paste(unique(congregation_name), collapse = " | "),
    total_attendance = sum(attendance_2023, na.rm = TRUE),
    .groups = 'drop'
  ) |>
  arrange(desc(num_congregations))

# Calculate stats for callout
unique_addresses <- n_distinct(shared_addresses$sadd)
unique_congregations <- n_distinct(shared_addresses$congregation_name)
```

```{r shared-callout, echo=FALSE, results='asis'}
cat("::: {.callout-note}\n")
cat("## Findings\n")
cat("**", unique_addresses, "** addresses are shared by multiple congregations, affecting **", unique_congregations, "** different congregations.\n", sep = "")
cat(":::\n")
```

**Properties sharing addresses may indicate:**

1.  **Ethnic/language congregations** sharing space (Korean, Vietnamese, Spanish services)
2.  **Church plants** using host congregation facilities
3.  **Rental arrangements** - one congregation renting to another
4.  **Merged congregations** - maintaining separate legal entities
5.  **Data quality issues** - duplicate records or address errors

```{r shared-table, echo=FALSE}
if(nrow(shared_summary) > 0) {
  shared_summary |>
    kable(
      col.names = c("Street Address", "City", "# Congregations", "Congregation Names", "Combined Attendance"),
      digits = 0
    ) |>
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
    column_spec(3, bold = TRUE) |>
    row_spec(which(shared_summary$num_congregations >= 3), background = "#d1ecf1")
} else {
  cat("âœ“ No shared addresses found\n")
}
```

------------------------------------------------------------------------

### Priority Issues Summary

```{r priority-summary, echo=FALSE}
# Categorize problems
problem_categories <- problem_matrix |>
  count(address_status) |>
  arrange(desc(n))
```

**Problem Distribution:**

```{r priority-table, echo=FALSE}
problem_categories |>
  kable(
    col.names = c("Issue Type", "# Congregations"),
    digits = 0
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  row_spec(which(grepl("Both", problem_categories$address_status)), 
           background = "#f8d7da", bold = TRUE)
```

------------------------------------------------------------------------

# Summary Statistics

## Property Portfolio Overview

### Property Use Types

```{r use-type-breakdown}
# Create use type classification
use_stats <- property_profile |>
  mutate(
    primary_use = case_when(
      use_cemetery ~ "Cemetery",
      use_school ~ "School",
      use_parking ~ "Parking",
      use_open_space ~ "Open Space",
      use_residence ~ "Residential",
      use_church ~ "Church/Worship",
      TRUE ~ "Other/Mixed"
    )
  ) |>
  group_by(primary_use) |>
  summarise(
    n_parcels = n(),
    total_acres = sum(area_acres, na.rm = TRUE),
    avg_value = mean(assessed_value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(desc(n_parcels))

ggplot(use_stats, aes(x = reorder(primary_use, n_parcels), y = n_parcels)) +
  geom_col(fill = "#445ca9", alpha = 0.8) +
  geom_text(aes(label = n_parcels), hjust = -0.2, color = "#445ca9", fontface = "bold") +
  coord_flip() +
  labs(
    title = "Property Distribution by Primary Use",
    x = "",
    y = "Number of Parcels"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14, color = "#445ca9")
  )
```

## Geographic Distribution

### Parcels by Diocesan Region

```{r regional-distribution-calc, include=FALSE}
# Regional breakdown
regional_stats <- property_profile |>
  summarise(
    n_parcels = n(),
    total_acres = sum(area_acres, na.rm = TRUE),
    pct_of_total_acres = (total_acres / sum(property_profile$area_acres, na.rm = TRUE)) * 100,
    avg_score = mean(development_score, na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(desc(n_parcels))
```

```{r regional-distribution-html}
regional_stats |>
  kable(
    col.names = c("# Parcels", "Total Acres", "% of Total Acreage", "Avg Dev Score"),
    digits = c(0, 0, 1, 1, 1)
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover")) |>
  row_spec(0, bold = TRUE, background = "#8baeaa", color = "white")
```

## Congregation Vitality Metrics

```{r congregation-metrics, echo=FALSE, results='asis'}
# Congregation statistics
cong_stats <- property_profile |>
  filter(has_congregation) |>
  summarise(
    parcels_with_cong_data = n(),
    parcels_under_30_attendance = sum(avg_attendance < 30, na.rm = TRUE),
    pct_under_30 = (parcels_under_30_attendance / n()) * 100,
    avg_attendance_all = mean(avg_attendance, na.rm = TRUE),
    avg_pledge_all = mean(avg_pledge, na.rm = TRUE),
    declining_pledges = sum(pct_change_pledge < 0, na.rm = TRUE)
  )

cat("**Key Congregation Metrics:**\n\n")
cat("- **Parcels with congregation data:** ", cong_stats$parcels_with_cong_data, "\n", sep = "")
cat("- **Parcels with <30 Sunday attendance:** ", cong_stats$parcels_under_30_attendance, 
    " (", round(cong_stats$pct_under_30, 1), "% of properties analyzed)\n", sep = "")
cat("- **Average Sunday attendance:** ", round(cong_stats$avg_attendance_all, 0), " people\n", sep = "")
cat("- **Average annual pledge:** $", scales::comma(cong_stats$avg_pledge_all, accuracy = 1), "\n", sep = "")
cat("- **Congregations with declining pledges:** ", cong_stats$declining_pledges, "\n\n", sep = "")
```

## Developable Land Summary

### Comprehensive Developability Analysis

```{r developable-summary, echo=FALSE}
# Summary of ALL developable land (not just top 10)
developable_summary <- property_profile |>
  filter(development_score >= 45) |>  # Tier 3 and above
  summarise(
    n_developable = n(),
    total_dev_acres = sum(area_acres, na.rm = TRUE),
    total_dev_value = sum(assessed_value, na.rm = TRUE),
    avg_attendance = mean(avg_attendance, na.rm = TRUE),
    avg_pledge = mean(avg_pledge, na.rm = TRUE),
    parcels_under_30 = sum(avg_attendance < 30, na.rm = TRUE)
  )

# By tier
tier_summary <- property_profile |>
  filter(development_score >= 45) |>
  group_by(development_potential) |>
  summarise(
    n_parcels = n(),
    total_acres = sum(area_acres, na.rm = TRUE),
    total_value = sum(assessed_value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(desc(n_parcels))
```

```{r output-dev-summary, echo=FALSE, results='asis'}
cat("**All Developable Properties (Score â‰¥45)**\n\n")

# Create stat boxes
cat("::: {layout-ncol=4}\n")

cat("::: {.stat-box}\n")
cat("::: {.stat-number}\n", developable_summary$n_developable, "\n:::\n", sep = "")
cat("::: {.stat-label}\nDevelopable Parcels\n:::\n:::\n\n")

cat("::: {.stat-box}\n")
cat("::: {.stat-number}\n", round(developable_summary$total_dev_acres, 1), "\n:::\n", sep = "")
cat("::: {.stat-label}\nDevelopable Acres\n:::\n:::\n\n")

cat("::: {.stat-box}\n")
cat("::: {.stat-number}\n$", scales::comma(developable_summary$total_dev_value / 1e6, accuracy = 0.1), "M\n:::\n", sep = "")
cat("::: {.stat-label}\nAssessed Value\n:::\n:::\n\n")

cat("::: {.stat-box}\n")
cat("::: {.stat-number}\n", developable_summary$parcels_under_30, "\n:::\n", sep = "")
cat("::: {.stat-label}\nWith <30 Attendance\n:::\n:::\n\n")

cat(":::\n\n")

cat("### Breakdown by Development Tier\n\n")
```

```{r tier-breakdown-html}
tier_summary |>
  kable(
    col.names = c("Tier", "# Parcels", "Total Acres", "Assessed Value"),
    digits = c(0, 0, 1, 0),
    format.args = list(big.mark = ",")
  ) |>
  kable_styling(bootstrap_options = c("striped", "hover"))
```

------------------------------------------------------------------------

# Property Profiles

## Overview

The following section provides detailed profiles for each of the top 10 development opportunities. Each profile includes:

-   Site characteristics and current use
-   Congregation context (where applicable)
-   Development opportunities and strategies
-   Key considerations and next steps

```{r property-profiles, results='asis'}

create_property_profile <- function(rank_num) {
  property <- top_10 |> filter(rank == rank_num)
  
  if(nrow(property) == 0) return(NULL)
  
  prop_id <- paste0("prop_", rank_num)
  
  cat("\n\n## Property #", rank_num, " {.unnumbered}\n\n", sep = "")
  cat("### ", property$site_address, "\n", sep = "")
  cat("**", property$site_city, ", ", property$site_county, " County**\n\n", sep = "")
  
  tier_type <- case_when(
    property$development_score >= 75 ~ "important",
    property$development_score >= 60 ~ "tip",
    TRUE ~ "note"
  )
  
  cat(":::{.callout-", tier_type, "}\n", sep = "")
  cat("## Development Score: **", round(property$development_score, 1), "/100**\n\n", sep = "")
  cat("**", property$development_tier, "**\n", sep = "")
  cat(":::\n\n")
  
  cat("::: {layout-ncol=3}\n")
  cat("::: {}\n**", round(property$area_acres, 2), " acres**  \n", sep = "")
  cat("Property Size\n:::\n")
  
  cat("::: {}\n**", round(property$walkability_score, 1), "/100**  \n", sep = "")
  cat("Walkability\n:::\n")
  
  cat("::: {}\n**", 
      ifelse(!is.na(property$avg_attendance), 
             paste0(round(property$avg_attendance), " people"), "N/A"), "**  \n", sep = "")
  cat("Avg Attendance\n:::\n")
  cat(":::\n\n")
  
  cat("#### Site Characteristics\n\n")
  cat("- **Current Uses:**")
  uses <- c()
  if(!is.na(property$use_church) && property$use_church) uses <- c(uses, "Church building")
  if(!is.na(property$use_parking) && property$use_parking) uses <- c(uses, "Parking lot")
  if(!is.na(property$use_open_space) && property$use_open_space) uses <- c(uses, "Open space")
  if(length(uses) > 0) {
    cat(" ", paste(uses, collapse = ", "), "\n", sep = "")
  } else {
    cat(" Mixed use\n")
  }
  
  if(!is.na(property$name)) {
    cat("\n#### Congregation: ", property$name, "\n\n", sep = "")
    
    if(!is.na(property$pct_change_pledge)) {
      change_dir <- ifelse(property$pct_change_pledge < 0, "â†“ decreased", "â†‘ increased")
      cat("**Financial Trend:** Plate & pledge has ", change_dir, " by **", 
          abs(round(property$pct_change_pledge, 1)), "%** over the past decade.\n\n", sep = "")
    }
  }
  
  cat("#### Development Opportunities\n\n")
  if(!is.na(property$use_parking) && property$use_parking) {
    cat("ðŸ…¿ï¸ **Prime opportunity:** Underutilized parking can support structured parking with mixed-use above\n\n")
  }
  if(!is.na(property$area_acres) && property$area_acres > 1) {
    cat("ðŸ“ **Substantial site:** Large parcel enables phased development or creative master planning\n\n")
  }
  if(!is.na(property$walkability_score) && property$walkability_score > 10) {
    cat("ðŸš¶ **Walkable location:** Transit access supports reduced parking requirements and higher density\n\n")
  }
  
  cat("#### Recommended Next Steps\n\n")
  cat("1. Site feasibility study and geotechnical analysis\n")
  cat("2. Congregation leadership engagement\n")
  cat("3. Zoning review and density bonus evaluation\n")
  if(!is.na(property$financial_need) && property$financial_need >= 2) {
    cat("4. Ground lease financial modeling\n")
  }

cat("\n---\n\n")
cat("## Interactive ADU Placement Tool\n\n")
cat("For an interactive experience where you can place and explore ADU designs on these properties, ")
cat('[**launch the interactive dashboard**](http://localhost:3838) (run `shiny::runApp("app.R")` in your R console).\n\n')
cat("The dashboard includes:\n\n")
cat("- Interactive map with click-to-place ADU functionality\n")
cat("- Multiple ADU design options\n")
cat("- Real-time property visualization\n")
cat("- Satellite and street view toggles\n\n")

# Generate all profiles
for(i in 1:10) {
  create_property_profile(i)
}
```

------------------------------------------------------------------------

# Appendices {.unnumbered}

::: {.callout-note collapse="true"}
## Technical Methodology

**Scoring Algorithm Details**

Each property receives scores across six dimensions (0-100 scale), which are then weighted and combined:

1.  **Size Score (20% weight):** Properties between 0.5-5 acres score highest (100 points)
2.  **Use Score (25% weight):** Parking lots (95) and open space (90) score highest
3.  **Location Score (20% weight):** Based on walkability index and transit access
4.  **Financial Score (15% weight):** Congregation pledge trends indicate development need
5.  **Market Score (10% weight):** Area median income and LIHTC eligibility
6.  **Zoning Score (10% weight):** Development-friendly zoning receives 80 points

**Constraint penalties** are applied after the weighted average, with major penalties for: - Flood zones: -40 points - Significant wetlands (\>25%): -35 points\
- Easements: -30 points - Historic districts: -25 points

Final scores are capped between 0-100.
:::

::: {.callout-note collapse="true"}
## Data Processing Notes

**Congregation-Parcel Joining:** Properties were matched to congregation data using the `congr_name` field. Properties without matches received neutral financial scores.

**Missing Data Handling:** - Missing walkability scores defaulted to 0 - Missing income data received median market scores (50) - Properties without area or coordinates were excluded

**Quality Filters:** - Minimum parcel size: 0.1 acres - Required valid lat/lon coordinates - Valid building years: 1700-2025
:::
