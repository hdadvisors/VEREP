## Congregation Vitality Metrics
```{r}
source("R/common.R")
library(dplyr)
```


```{r}
#| label: congregation-metrics
#| echo: false
#| message: false

# Calculate parcels per congregation
parcels_per_cong <- property_profile |>
  filter(has_congregation) |>
  count(congregation_name) |>
  summarise(avg_parcels = mean(n))

# Congregation statistics
cong_stats <- property_profile |>
  filter(has_congregation) |>
  distinct(congregation_name, .keep_all = TRUE) |>
  summarise(
    congregations_with_data = n(),
    congregations_under_30_attendance = sum(avg_attendance < 30, na.rm = TRUE),
    pct_under_30 = (congregations_under_30_attendance / n()) * 100,
    avg_attendance_all = mean(avg_attendance, na.rm = TRUE),
    avg_pledge_all = mean(avg_pledge, na.rm = TRUE),
    declining_pledges = sum(pct_change_pledge < 0, na.rm = TRUE),
    need_count = sum(pct_change_pledge < 0 & pct_change_attendance < 0, na.rm = TRUE)
  )
```

**Key Congregation Metrics:**

::: {.grid}

::: {.g-col-4}
:::: {style="background: #445ca9; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;"}
[`r cong_stats$congregations_under_30_attendance`]{style="font-size: 2.5em; font-weight: bold; display: block;"}
Congregations with <30 Attendance
::::
:::

::: {.g-col-4}
:::: {style="background: #8baeaa; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;"}
[`r round(cong_stats$avg_attendance_all, 0)`]{style="font-size: 2.5em; font-weight: bold; display: block;"}
Avg Sunday Attendance
::::
:::

::: {.g-col-4}
:::: {style="background: #e9ab3f; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;"}
[`r scales::dollar(cong_stats$avg_pledge_all, accuracy = 1)`]{style="font-size: 2.5em; font-weight: bold; display: block;"}
Avg Annual Pledge
::::
:::

::: {.g-col-4}
:::: {style="background: #8baeaa; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;"}
[`r cong_stats$declining_pledges`]{style="font-size: 2.5em; font-weight: bold; display: block;"}
Declining Pledges
::::
:::

::: {.g-col-4}
:::: {style="background: #dc3545; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;"}
[`r cong_stats$need_count`]{style="font-size: 2.5em; font-weight: bold; display: block;"}
In Financial Need
::::
:::

::: {.g-col-4}
:::: {style="background: #445ca9; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 15px;"}
[`r round(parcels_per_cong$avg_parcels, 1)`]{style="font-size: 2.5em; font-weight: bold; display: block;"}
Avg Parcels per Congregation
::::
:::

:::
